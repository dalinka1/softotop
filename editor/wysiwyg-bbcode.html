<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visual WYSIWYG & BB Code Editor with Automatic Video and Image Embedding</title>
    <link rel="stylesheet" href="/menu/menu.css">
  <script src="/menu/menu.js" defer></script>
<style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px;
        }

        .mode-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            box-shadow: 0 5px 15px rgba(79, 70, 229, 0.4);
        }

        .mode-btn:not(.active) {
            background: #f3f4f6;
            color: #6b7280;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 15px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .toolbar-group {
            display: flex;
            gap: 5px;
            padding: 5px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .toolbar-btn {
            padding: 8px 12px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .toolbar-btn:hover {
            background: #e5e7eb;
            color: #1f2937;
        }

        .toolbar-btn.active {
            background: #3b82f6;
            color: white;
        }

        .toolbar-separator {
            width: 1px;
            background: #d1d5db;
            margin: 5px 0;
        }

        .bbcode-only {
            display: none;
        }

        .editor-container {
            display: flex;
            height: 600px;
        }

        .visual-editor {
            flex: 1;
            padding: 20px;
            border: none;
            outline: none;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            overflow-y: auto;
            background: white;
        }

        .bbcode-editor {
            flex: 1;
            padding: 20px;
            border: none;
            outline: none;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            background: #1e293b;
            color: #e2e8f0;
            overflow-y: auto;
            white-space: pre-wrap;
            resize: none;
        }

        .hidden {
            display: none !important;
        }

        /* Стили для визуального редактора */
        .visual-editor h1 { font-size: 2em; font-weight: bold; margin: 1em 0 0.5em 0; color: #1f2937; }
        .visual-editor h2 { font-size: 1.5em; font-weight: bold; margin: 1em 0 0.5em 0; color: #374151; }
        .visual-editor h3 { font-size: 1.2em; font-weight: bold; margin: 1em 0 0.5em 0; color: #4b5563; }
        .visual-editor p { margin: 0.5em 0; }
        .visual-editor strong { font-weight: bold; }
        .visual-editor b { font-weight: bold; }
        .visual-editor em { font-style: italic; }
        .visual-editor i { font-style: italic; }
        .visual-editor u { text-decoration: underline; }
        .visual-editor s { text-decoration: line-through; }
        .visual-editor a { 
            color: #3b82f6; 
            text-decoration: underline; 
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .visual-editor a:hover { 
            color: #1d4ed8;
        }
        .visual-editor img { 
            max-width: 100%; 
            height: auto; 
            margin: 10px 0; 
            border-radius: 8px; 
            display: block;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        .visual-editor img:hover {
            transform: scale(1.02);
        }
        .visual-editor .youtube-video {
            margin: 15px 0;
            width: 640px;
            height: 360px;
            max-width: 100%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
        }
        .visual-editor .youtube-video iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        .visual-editor ul { margin: 1em 0; padding-left: 2em; }
        .visual-editor ol { margin: 1em 0; padding-left: 2em; }
        .visual-editor li { margin: 0.2em 0; }
        .visual-editor blockquote {
            margin: 1em 0;
            padding: 15px 20px;
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            font-style: italic;
            border-radius: 0 8px 8px 0;
        }
        .visual-editor table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .visual-editor th, .visual-editor td {
            border: 1px solid #e2e8f0;
            padding: 12px;
            text-align: left;
        }
        .visual-editor th {
            background: #f1f5f9;
            font-weight: bold;
        }
        .visual-editor code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        /* Стили для выравнивания */
        .text-left { text-align: left !important; }
        .text-center { text-align: center !important; }
        .text-right { text-align: right !important; }

        .status-bar {
            padding: 10px 20px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            font-size: 12px;
            color: #6b7280;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 15px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #374151;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 70, 229, 0.4);
        }

        /* BB-код предпросмотр в визуальном редакторе */
        .bb-preview {
            display: inline;
        }

        .bb-link {
            color: #3b82f6;
            text-decoration: underline;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .bb-link:hover {
            color: #1d4ed8;
        }

        .bb-image {
            max-width: 100%;
            height: auto;
            margin: 10px 0;
            border-radius: 8px;
            display: block;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1001;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #ef4444;
        }

        .image-loading {
            display: inline-block;
            padding: 10px;
            background: #f3f4f6;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            color: #6b7280;
            font-style: italic;
        }

        .image-error {
            display: inline-block;
            padding: 10px;
            background: #fef2f2;
            border: 2px dashed #fca5a5;
            border-radius: 8px;
            color: #dc2626;
            font-style: italic;
        }

        /* Стили для пикера цвета */
        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .color-input {
            width: 40px;
            height: 32px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            padding: 2px;
        }

        .color-input::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .color-input::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .toolbar {
                flex-direction: column;
                gap: 10px;
            }
            
            .toolbar-group {
                justify-content: center;
            }
            
            .editor-container {
                height: 400px;
            }

            .visual-editor .youtube-video {
                width: 100%;
                height: auto;
                aspect-ratio: 16/9;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎨  WYSIWYG & BB Code Editor</h1>
            <p>Вставляйте ссылки на изображения и видео - они автоматически станут визуальными!</p>
        </div>

        <div class="mode-toggle">
            <button class="mode-btn active" onclick="switchMode('visual')">📝 Визуальный режим</button>
            <button class="mode-btn" onclick="switchMode('bbcode')">💻 BB-код</button>
        </div>

        <div class="toolbar" id="toolbar">
            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="execCommand('bold')" title="Жирный">
                    <strong>B</strong>
                </button>
                <button class="toolbar-btn" onclick="execCommand('italic')" title="Курсив">
                    <em>I</em>
                </button>
                <button class="toolbar-btn" onclick="execCommand('underline')" title="Подчеркнутый">
                    <u>U</u>
                </button>
                <button class="toolbar-btn" onclick="execCommand('strikeThrough')" title="Зачеркнутый">
                    <s>S</s>
                </button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group color-picker-group">
                <button class="toolbar-btn" title="Цвет текста">
                    🎨 Текст
                </button>
                <input type="color" id="textColorPicker" class="color-input" value="#000000" title="Выбрать цвет текста">
                <button class="toolbar-btn" title="Цвет фона">
                    🖌️ Фон
                </button>
                <input type="color" id="bgColorPicker" class="color-input" value="#ffff00" title="Выбрать цвет фона">
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="formatHeading('h1')" title="Заголовок 1">H1</button>
                <button class="toolbar-btn" onclick="formatHeading('h2')" title="Заголовок 2">H2</button>
                <button class="toolbar-btn" onclick="formatHeading('h3')" title="Заголовок 3">H3</button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="alignText('left')" title="Выровнять по левому краю">
                    ⬅️ Лево
                </button>
                <button class="toolbar-btn" onclick="alignText('center')" title="Выровнять по центру">
                    ⬆️ Центр
                </button>
                <button class="toolbar-btn" onclick="alignText('right')" title="Выровнять по правому краю">
                    ➡️ Право
                </button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="execCommand('insertUnorderedList')" title="Маркированный список">
                    • Список
                </button>
                <button class="toolbar-btn" onclick="execCommand('insertOrderedList')" title="Нумерованный список">
                    1. Список
                </button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="showLinkModal()" title="Вставить ссылку">
                    🔗 Ссылка
                </button>
                <button class="toolbar-btn" onclick="showImageModal()" title="Вставить изображение">
                    🖼️ Картинка
                </button>
                <button class="toolbar-btn" onclick="showVideoModal()" title="Вставить видео">
                    🎥 Видео
                </button>
                <button class="toolbar-btn" onclick="insertQuote()" title="Цитата">
                    💬 Цитата
                </button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="showTableModal()" title="Вставить таблицу">
                    📊 Таблица
                </button>
                <button class="toolbar-btn" onclick="insertCode()" title="Код">
                    &lt;/&gt; Код
                </button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="clearEditor()" title="Очистить редактор">
                    🗑️ Очистить
                </button>
                <button class="toolbar-btn" onclick="clearFormatting()" title="Очистить форматирование">
                    🧹 Формат
                </button>
            </div>
        </div>

        <div class="toolbar bbcode-only" id="bbcodeToolbar">
            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="removeSize()" title="Убрать размеры из BB-кода">
                    📏 Без size
                </button>
                <button class="toolbar-btn" onclick="removeColors()" title="Убрать все цвета из BB-кода">
                    🎨 Без color
                </button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group">
                <button class="toolbar-btn" onclick="convertToMyBB()" title="Конвертировать в формат MyBB">
                    🔄 MyBB
                </button>
                <button class="toolbar-btn" onclick="removeLists()" title="Убрать все списки">
                    🗑️ Убрать списки
                </button>
                <button class="toolbar-btn" onclick="copyBBCode()" title="Копировать BB-код">
                    📋 Копировать код
                </button>
            </div>
        </div>

        <div class="editor-container">
            <div id="visualEditor" class="visual-editor" contenteditable="true" onkeyup="handleEditorInput()" onmouseup="handleEditorInput()" onpaste="handlePaste(event)"></div>

            <textarea id="bbcodeEditor" class="bbcode-editor hidden" onkeyup="updateVisual()" onpaste="setTimeout(updateVisual, 10)"></textarea>
        </div>

        <div class="status-bar">
            <span>Режим: <span id="currentMode">Визуальный</span></span>
            <span>BB-тегов: <span id="bbtagCount">0</span></span>
            <span>Символов: <span id="charCount">0</span></span>
            <span>Изображений: <span id="imageCount">0</span></span>
        </div>
    </div>

    <!-- Модальные окна -->
    <div id="linkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Вставить ссылку</h3>
                <span class="close" onclick="closeLinkModal()">&times;</span>
            </div>
            <div class="form-group">
                <label for="linkText">Текст ссылки:</label>
                <input type="text" id="linkText" placeholder="Введите текст ссылки">
            </div>
            <div class="form-group">
                <label for="linkUrl">URL:</label>
                <input type="text" id="linkUrl" placeholder="https://example.com">
            </div>
            <button class="btn-primary" onclick="insertLink()">Вставить ссылку</button>
        </div>
    </div>

    <div id="imageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Вставить изображение</h3>
                <span class="close" onclick="closeImageModal()">&times;</span>
            </div>
            <div class="form-group">
                <label for="imageUrl">URL изображения:</label>
                <input type="text" id="imageUrl" placeholder="https://example.com/image.jpg">
            </div>
            <div class="form-group">
                <label for="imageAlt">Альтернативный текст:</label>
                <input type="text" id="imageAlt" placeholder="Описание изображения">
            </div>
            <button class="btn-primary" onclick="insertImage()">Вставить изображение</button>
        </div>
    </div>

    <div id="videoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Вставить видео</h3>
                <span class="close" onclick="closeVideoModal()">&times;</span>
            </div>
            <div class="form-group">
                <label for="videoUrl">URL видео YouTube:</label>
                <input type="text" id="videoUrl" placeholder="https://www.youtube.com/watch?v=...">
            </div>
            <div class="form-group">
                <label for="videoWidth">Ширина видео:</label>
                <select id="videoWidth">
                    <option value="560">560px (стандартная)</option>
                    <option value="640" selected>640px (средняя)</option>
                    <option value="800">800px (большая)</option>
                    <option value="100%">100% (адаптивная)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="videoHeight">Высота видео:</label>
                <select id="videoHeight">
                    <option value="315">315px (стандартная)</option>
                    <option value="360" selected>360px (средняя)</option>
                    <option value="450">450px (большая)</option>
                    <option value="auto">Авто (16:9)</option>
                </select>
            </div>
            <button class="btn-primary" onclick="insertVideo()">Вставить видео</button>
        </div>
    </div>

    <div id="tableModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Вставить таблицу</h3>
                <span class="close" onclick="closeTableModal()">&times;</span>
            </div>
            <div class="form-group">
                <label for="tableRows">Количество строк:</label>
                <input type="number" id="tableRows" value="3" min="1" max="10">
            </div>
            <div class="form-group">
                <label for="tableCols">Количество столбцов:</label>
                <input type="number" id="tableCols" value="3" min="1" max="10">
            </div>
            <button class="btn-primary" onclick="insertTable()">Вставить таблицу</button>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        let currentMode = 'visual';
        let isUpdating = false;
        let processingYouTube = false;
        let processingImages = false;
        let savedSelection = null;
        let savedScrollPosition = 0;

        const supportedImageFormats = [
            '.jpg', '.jpeg', '.png', '.webp', '.svg', '.gif', '.avif', '.heic', '.tiff', '.bmp', '.raw'
        ];

        function isImageUrl(url) {
            if (!url || typeof url !== 'string') return false;
            
            const cleanUrl = url.split('?')[0].toLowerCase();
            const hasImageExtension = supportedImageFormats.some(ext => cleanUrl.endsWith(ext));
            const hasImagePattern = /\.(jpg|jpeg|png|webp|svg|gif|avif|heic|tiff|bmp|raw)(\?|$)/i.test(url);
            
            return hasImageExtension || hasImagePattern;
        }

        function createLoadingIndicator(url) {
            return `<span class="image-loading">⏳ Загрузка изображения...</span>`;
        }

        function createErrorIndicator(url) {
            return `<span class="image-error">❌ Ошибка загрузки: ${url}</span>`;
        }

        // ИСПРАВЛЕННЫЕ ФУНКЦИИ для работы с цветом
        function changeTextColor(color) {
            const visualEditor = document.getElementById('visualEditor');
            visualEditor.focus();
            
            // Восстанавливаем выделение перед применением цвета
            if (savedSelection) {
                restoreSelection();
            }
            
            document.execCommand('foreColor', false, color);
            
            setTimeout(() => {
                updateBBCode();
            }, 50);
        }

        function changeBackgroundColor(color) {
            const visualEditor = document.getElementById('visualEditor');
            visualEditor.focus();
            
            // Восстанавливаем выделение перед применением цвета
            if (savedSelection) {
                restoreSelection();
            }
            
            // Используем backColor для Firefox и hiliteColor для Chrome/Safari
            if (!document.execCommand('hiliteColor', false, color)) {
                document.execCommand('backColor', false, color);
            }
            
            setTimeout(() => {
                updateBBCode();
            }, 50);
        }

        function rgbToHex(rgb) {
            if (!rgb) return null;
            
            // Если уже hex
            if (rgb.startsWith('#')) return rgb.toLowerCase();
            
            // Парсим rgb/rgba
            const result = rgb.match(/\d+/g);
            if (!result || result.length < 3) return null;
            
            const r = parseInt(result[0]);
            const g = parseInt(result[1]);
            const b = parseInt(result[2]);
            
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toLowerCase();
        }

        function saveSelection() {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                try {
                    savedSelection = selection.getRangeAt(0).cloneRange();
                } catch (e) {
                    savedSelection = null;
                }
            } else {
                savedSelection = null;
            }
            const visualEditor = document.getElementById('visualEditor');
            savedScrollPosition = visualEditor.scrollTop;
        }

        function restoreSelection() {
            if (savedSelection) {
                try {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(savedSelection);
                } catch (e) {
                    const visualEditor = document.getElementById('visualEditor');
                    const range = document.createRange();
                    range.selectNodeContents(visualEditor);
                    range.collapse(false);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }
            const visualEditor = document.getElementById('visualEditor');
            visualEditor.scrollTop = savedScrollPosition;
        }

        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification show' + (isError ? ' error' : '');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function handleEditorInput() {
            if (currentMode === 'visual' && !isUpdating) {
                clearTimeout(window.editorTimeout);
                window.editorTimeout = setTimeout(() => {
                    saveSelection();
                    processImageUrls();
                    processYouTubeLinks();
                    processBBCodeInVisualEditor();
                    updateBBCode();
                    updateImageCount();
                }, 300);
            }
        }

        function processImageUrls() {
            if (processingImages) return;
            processingImages = true;
            
            const visualEditor = document.getElementById('visualEditor');
            let content = visualEditor.innerHTML;
            let hasChanges = false;
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            const walker = document.createTreeWalker(
                tempDiv,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            const textNodes = [];
            let node;
            while (node = walker.nextNode()) {
                textNodes.push(node);
            }
            
            textNodes.forEach(textNode => {
                const text = textNode.textContent;
                const urlRegex = /https?:\/\/[^\s<>"]+/gi;
                const urls = text.match(urlRegex) || [];
                
                urls.forEach(url => {
                    if (isImageUrl(url)) {
                        const imgElement = document.createElement('img');
                        imgElement.src = url;
                        imgElement.className = 'bb-image';
                        imgElement.alt = 'Автоматически добавленное изображение';
                        imgElement.style.maxWidth = '100%';
                        imgElement.style.height = 'auto';
                        
                        imgElement.onerror = function() {
                            this.style.border = '2px dashed #fca5a5';
                            this.style.padding = '20px';
                            this.style.background = '#fef2f2';
                            this.style.color = '#dc2626';
                            this.style.fontStyle = 'italic';
                            this.textContent = '❌ Ошибка загрузки изображения: ' + url;
                            this.removeAttribute('src');
                        };
                        
                        const parts = text.split(url);
                        if (parts.length === 2) {
                            textNode.textContent = parts[0];
                            const afterTextNode = document.createTextNode(parts[1]);
                            
                            if (textNode.parentNode) {
                                textNode.parentNode.insertBefore(imgElement, textNode.nextSibling);
                                textNode.parentNode.insertBefore(afterTextNode, imgElement.nextSibling);
                                hasChanges = true;
                            }
                        }
                    }
                });
            });
            
            if (hasChanges) {
                visualEditor.innerHTML = tempDiv.innerHTML;
                restoreSelection();
            }
            
            processingImages = false;
        }

        function updateImageCount() {
            const imageCount = document.getElementById('imageCount');
            const visualEditor = document.getElementById('visualEditor');
            const images = visualEditor.querySelectorAll('img');
            imageCount.textContent = images.length;
        }

        function handlePaste(e) {
            e.preventDefault();
            
            const clipboardData = e.clipboardData || window.clipboardData;
            let htmlData = clipboardData.getData('text/html');
            let textData = clipboardData.getData('text/plain');
            
            if (htmlData) {
                processAndInsertHTML(htmlData);
            } else if (textData) {
                const hasImageUrls = textData.split(/\s+/).some(word => isImageUrl(word));
                
                if (textData.includes('[url=') || textData.includes('[img]') || textData.includes('[/url]') || textData.includes('[/img]') || 
                    textData.includes('youtube.com') || textData.includes('youtu.be') || hasImageUrls) {
                    document.execCommand('insertText', false, textData);
                    setTimeout(() => {
                        processImageUrls();
                        processYouTubeLinks();
                        processBBCodeInVisualEditor();
                        updateBBCode();
                        updateImageCount();
                    }, 100);
                } else {
                    document.execCommand('insertText', false, textData);
                    setTimeout(updateBBCode, 50);
                }
            }
        }

        function processYouTubeLinks() {
            if (processingYouTube) return;
            processingYouTube = true;
            
            const visualEditor = document.getElementById('visualEditor');
            let content = visualEditor.innerHTML;
            let hasChanges = false;
            
            const youtubePatterns = [
                /(?<!src=")[^<>\s"]*https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)[^<>\s"]*/g,
                /(?<!src=")[^<>\s"]*https?:\/\/youtu\.be\/([a-zA-Z0-9_-]+)[^<>\s"]*/g
            ];

            youtubePatterns.forEach(pattern => {
                content = content.replace(pattern, function(match, videoId) {
                    if (match.includes('iframe') || match.includes('embed')) {
                        return match;
                    }
                    hasChanges = true;
                    return `<div class="youtube-video" data-video-id="${videoId}" data-width="640" data-height="360"><iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe></div>`;
                });
            });

            if (hasChanges) {
                visualEditor.innerHTML = content;
                restoreSelection();
            }
            
            processingYouTube = false;
        }

        function processAndInsertHTML(htmlData) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlData;
            
            processStyledContent(tempDiv);
            
            const processedHtml = tempDiv.innerHTML;
            document.execCommand('insertHTML', false, processedHtml);
            
            setTimeout(() => {
                processImageUrls();
                processYouTubeLinks();
                processBBCodeInVisualEditor();
                updateBBCode();
                updateImageCount();
            }, 100);
        }

        function processStyledContent(element) {
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_ELEMENT,
                null,
                false
            );

            const elementsToProcess = [];
            let node;
            
            while (node = walker.nextNode()) {
                elementsToProcess.push(node);
            }
            
            elementsToProcess.unshift(element);

            for (let i = elementsToProcess.length - 1; i >= 0; i--) {
                const el = elementsToProcess[i];
                convertStylesToTags(el);
            }
        }

        function convertStylesToTags(element) {
            if (!element || element.nodeType !== Node.ELEMENT_NODE) return;

            const computedStyle = element.style ? window.getComputedStyle(element) : null;
            const inlineStyle = element.style || {};
            
            // Обработка цвета текста и фона из inline styles
            let colorStyle = inlineStyle.color;
            let backgroundColorStyle = inlineStyle.backgroundColor;
            
            // Если нет inline стилей, проверяем computed styles
            if (!colorStyle && computedStyle) {
                colorStyle = computedStyle.color;
            }
            if (!backgroundColorStyle && computedStyle) {
                backgroundColorStyle = computedStyle.backgroundColor;
            }
            
            const fontWeight = inlineStyle.fontWeight || (computedStyle ? computedStyle.fontWeight : '');
            const fontStyle = inlineStyle.fontStyle || (computedStyle ? computedStyle.fontStyle : '');
            const textDecoration = inlineStyle.textDecoration || (computedStyle ? computedStyle.textDecoration : '');
            
            let replacement = element;
            let hasChanges = false;

            // Обработка цвета текста
            if (colorStyle && colorStyle !== 'rgb(0, 0, 0)' && colorStyle !== '#000000' && colorStyle !== 'black') {
                const hexColor = rgbToHex(colorStyle);
                if (hexColor && hexColor !== '#000000') {
                    const colorSpan = document.createElement('span');
                    colorSpan.style.color = hexColor;
                    
                    while (replacement.firstChild) {
                        colorSpan.appendChild(replacement.firstChild);
                    }
                    replacement.appendChild(colorSpan);
                    hasChanges = true;
                }
            }

            // Обработка цвета фона
            if (backgroundColorStyle && backgroundColorStyle !== 'rgba(0, 0, 0, 0)' && backgroundColorStyle !== 'transparent') {
                const hexBgColor = rgbToHex(backgroundColorStyle);
                if (hexBgColor) {
                    const bgSpan = document.createElement('span');
                    bgSpan.style.backgroundColor = hexBgColor;
                    
                    while (replacement.firstChild) {
                        bgSpan.appendChild(replacement.firstChild);
                    }
                    replacement.appendChild(bgSpan);
                    hasChanges = true;
                }
            }

            // Обработка форматирования
            if (fontWeight === '700' || fontWeight === 'bold' || fontWeight === '800' || fontWeight === '900' || 
                parseInt(fontWeight) >= 700) {
                const strong = document.createElement('strong');
                while (replacement.firstChild) {
                    strong.appendChild(replacement.firstChild);
                }
                replacement.appendChild(strong);
                hasChanges = true;
            }
            
            if (fontStyle === 'italic' || fontStyle === 'oblique') {
                const em = document.createElement('em');
                while (replacement.firstChild) {
                    em.appendChild(replacement.firstChild);
                }
                replacement.appendChild(em);
                hasChanges = true;
            }
            
            if (textDecoration && textDecoration.includes('underline')) {
                const u = document.createElement('u');
                while (replacement.firstChild) {
                    u.appendChild(replacement.firstChild);
                }
                replacement.appendChild(u);
                hasChanges = true;
            }
            
            if (textDecoration && (textDecoration.includes('line-through') || textDecoration.includes('strikethrough'))) {
                const s = document.createElement('s');
                while (replacement.firstChild) {
                    s.appendChild(replacement.firstChild);
                }
                replacement.appendChild(s);
                hasChanges = true;
            }

            // Очистка стилей после конвертации
            if (hasChanges && element.style) {
                element.style.fontWeight = '';
                element.style.fontStyle = '';
                element.style.textDecoration = '';
                element.style.color = '';
                element.style.backgroundColor = '';
            }
        }

        function processBBCodeInVisualEditor() {
            const visualEditor = document.getElementById('visualEditor');
            let content = visualEditor.innerHTML;
            let hasChanges = false;

            content = content.replace(/\[url=([^\]]+)\]([^]*?)\[\/url\]/g, function(match, url, text) {
                if (match.includes('<a ')) return match;
                hasChanges = true;
                return `<a href="${url}" class="bb-link" target="_blank">${text}</a>`;
            });

            content = content.replace(/\[url\]([^]*?)\[\/url\]/g, function(match, url) {
                if (match.includes('<a ')) return match;
                hasChanges = true;
                return `<a href="${url}" class="bb-link" target="_blank">${url}</a>`;
            });

            content = content.replace(/\[img\]([^]*?)\[\/img\]/g, function(match, url) {
                if (match.includes('<img ')) return match;
                hasChanges = true;
                return `<img src="${url}" class="bb-image" alt="Изображение" onerror="this.style.border='2px dashed #ccc'; this.style.padding='20px'; this.textContent='❌ Ошибка загрузки изображения';">`;
            });

            if (hasChanges) {
                visualEditor.innerHTML = content;
                restoreSelection();
            }
        }

        function switchMode(mode) {
            if (isUpdating) return;
            
            currentMode = mode;
            const visualEditor = document.getElementById('visualEditor');
            const bbcodeEditor = document.getElementById('bbcodeEditor');
            const toolbar = document.getElementById('toolbar');
            const bbcodeToolbar = document.getElementById('bbcodeToolbar');
            const modeBtns = document.querySelectorAll('.mode-btn');
            const currentModeSpan = document.getElementById('currentMode');

            modeBtns.forEach(btn => btn.classList.remove('active'));
            
            if (mode === 'visual') {
                visualEditor.classList.remove('hidden');
                bbcodeEditor.classList.add('hidden');
                toolbar.style.display = 'flex';
                bbcodeToolbar.style.display = 'none';
                document.querySelector('.mode-btn[onclick*="visual"]').classList.add('active');
                currentModeSpan.textContent = 'Визуальный';
                updateBBCode();
            } else {
                visualEditor.classList.add('hidden');
                bbcodeEditor.classList.remove('hidden');
                toolbar.style.display = 'none';
                bbcodeToolbar.style.display = 'flex';
                document.querySelector('.mode-btn[onclick*="bbcode"]').classList.add('active');
                currentModeSpan.textContent = 'BB-код';
                updateBBCode();
            }
            
            updateCharCount();
            updateImageCount();
        }

        function execCommand(command, value = null) {
            document.execCommand(command, false, value);
            setTimeout(() => {
                updateBBCode();
                updateImageCount();
            }, 50);
        }

        function alignText(alignment) {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) return;

            const range = selection.getRangeAt(0);
            let element = range.commonAncestorContainer;
            
            if (element.nodeType === Node.TEXT_NODE) {
                element = element.parentNode;
            }

            while (element && element !== document.getElementById('visualEditor')) {
                if (element.tagName && ['P', 'DIV', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'BLOCKQUOTE'].includes(element.tagName)) {
                    break;
                }
                element = element.parentNode;
            }

            if (!element || element === document.getElementById('visualEditor')) {
                const visualEditor = document.getElementById('visualEditor');
                const allElements = visualEditor.querySelectorAll('p, div, h1, h2, h3, h4, h5, h6, blockquote, li');
                
                allElements.forEach(el => {
                    el.classList.remove('text-left', 'text-center', 'text-right');
                    if (alignment !== 'left') {
                        el.classList.add(`text-${alignment}`);
                    }
                });
            } else {
                element.classList.remove('text-left', 'text-center', 'text-right');
                if (alignment !== 'left') {
                    element.classList.add(`text-${alignment}`);
                }
            }

            setTimeout(updateBBCode, 50);
        }

        function formatHeading(tag) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                let parentElement = range.commonAncestorContainer;
                if (parentElement.nodeType === Node.TEXT_NODE) {
                    parentElement = parentElement.parentNode;
                }
                
                if (parentElement.tagName && parentElement.tagName.match(/^H[1-6]$/)) {
                    const newElement = document.createElement(tag.toUpperCase());
                    newElement.innerHTML = parentElement.innerHTML;
                    if (parentElement.classList.contains('text-center')) {
                        newElement.classList.add('text-center');
                    } else if (parentElement.classList.contains('text-right')) {
                        newElement.classList.add('text-right');
                    }
                    parentElement.parentNode.replaceChild(newElement, parentElement);
                    
                    const newRange = document.createRange();
                    newRange.selectNodeContents(newElement);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                } else {
                    document.execCommand('formatBlock', false, tag);
                }
            } else {
                document.execCommand('formatBlock', false, tag);
            }
            
            setTimeout(updateBBCode, 50);
        }

        function htmlToBBCode(html) {
            let bbcode = html;
            
            // Обработка цвета текста и фона с улучшенным парсингом
            bbcode = bbcode.replace(/<span[^>]*style="[^"]*background-color:\s*([^;"]+)[^"]*"[^>]*>(.*?)<\/span>/gis, function(match, bgColor, content) {
                const hexColor = rgbToHex(bgColor.trim());
                if (hexColor) {
                    return `[bgcolor=${hexColor}]${content}[/bgcolor]`;
                }
                return content;
            });

            bbcode = bbcode.replace(/<font[^>]*color="([^"]+)"[^>]*>(.*?)<\/font>/gis, '[color=$1]$2[/color]');
            bbcode = bbcode.replace(/<span[^>]*style="[^"]*color:\s*([^;"]+)[^"]*"[^>]*>(.*?)<\/span>/gis, function(match, color, content) {
                const hexColor = rgbToHex(color.trim());
                if (hexColor && hexColor !== '#000000') {
                    return `[color=${hexColor}]${content}[/color]`;
                }
                return content;
            });
            
            bbcode = bbcode.replace(/<div class="youtube-video"[^>]*data-video-id="([^"]+)"[^>]*data-width="([^"]+)"[^>]*data-height="([^"]+)"[^>]*>.*?<\/div>/gis, 
                function(match, videoId, width, height) {
                    const url = `https://www.youtube.com/watch?v=${videoId}`;
                    if (width === '640' && height === '360') {
                        return `[video]${url}[/video]\n`;
                    } else {
                        return `[video width=${width} height=${height}]${url}[/video]\n`;
                    }
                });
            
            bbcode = bbcode.replace(/<h1[^>]*class="[^"]*text-center[^"]*"[^>]*>(.*?)<\/h1>/gis, '[center][size=24][b]$1[/b][/size][/center]\n');
            bbcode = bbcode.replace(/<h1[^>]*class="[^"]*text-right[^"]*"[^>]*>(.*?)<\/h1>/gis, '[right][size=24][b]$1[/b][/size][/right]\n');
            bbcode = bbcode.replace(/<h1[^>]*>(.*?)<\/h1>/gis, '[size=24][b]$1[/b][/size]\n');
            
            bbcode = bbcode.replace(/<h2[^>]*class="[^"]*text-center[^"]*"[^>]*>(.*?)<\/h2>/gis, '[center][size=18][b]$1[/b][/size][/center]\n');
            bbcode = bbcode.replace(/<h2[^>]*class="[^"]*text-right[^"]*"[^>]*>(.*?)<\/h2>/gis, '[right][size=18][b]$1[/b][/size][/right]\n');
            bbcode = bbcode.replace(/<h2[^>]*>(.*?)<\/h2>/gis, '[size=18][b]$1[/b][/size]\n');
            
            bbcode = bbcode.replace(/<h3[^>]*class="[^"]*text-center[^"]*"[^>]*>(.*?)<\/h3>/gis, '[center][size=14][b]$1[/b][/size][/center]\n');
            bbcode = bbcode.replace(/<h3[^>]*class="[^"]*text-right[^"]*"[^>]*>(.*?)<\/h3>/gis, '[right][size=14][b]$1[/b][/size][/right]\n');
            bbcode = bbcode.replace(/<h3[^>]*>(.*?)<\/h3>/gis, '[size=14][b]$1[/b][/size]\n');
            
            bbcode = bbcode.replace(/<p[^>]*class="[^"]*text-center[^"]*"[^>]*>(.*?)<\/p>/gis, '[center]$1[/center]\n');
            bbcode = bbcode.replace(/<p[^>]*class="[^"]*text-right[^"]*"[^>]*>(.*?)<\/p>/gis, '[right]$1[/right]\n');
            bbcode = bbcode.replace(/<div[^>]*class="[^"]*text-center[^"]*"[^>]*>(.*?)<\/div>/gis, '[center]$1[/center]\n');
            bbcode = bbcode.replace(/<div[^>]*class="[^"]*text-right[^"]*"[^>]*>(.*?)<\/div>/gis, '[right]$1[/right]\n');
            
            bbcode = bbcode.replace(/<a[^>]*href=["']([^"']*?)["'][^>]*class=["'][^"']*bb-link[^"']*["'][^>]*>(.*?)<\/a>/gis, '[url=$1]$2[/url]');
            bbcode = bbcode.replace(/<a[^>]*class=["'][^"']*bb-link[^"']*["'][^>]*href=["']([^"']*?)["'][^>]*>(.*?)<\/a>/gis, '[url=$1]$2[/url]');
            bbcode = bbcode.replace(/<a[^>]*href=["']([^"']*?)["'][^>]*>(.*?)<\/a>/gis, '[url=$1]$2[/url]');
            
            bbcode = bbcode.replace(/<img[^>]*class=["'][^"']*bb-image[^"']*["'][^>]*src=["']([^"']*?)["'][^>]*\/?>/gi, '[img]$1[/img]');
            bbcode = bbcode.replace(/<img[^>]*src=["']([^"']*?)["'][^>]*class=["'][^"']*bb-image[^"']*["'][^>]*\/?>/gi, '[img]$1[/img]');
            bbcode = bbcode.replace(/<img[^>]*src=["']([^"']*?)["'][^>]*\/?>/gi, '[img]$1[/img]');
            
            bbcode = bbcode.replace(/<ul[^>]*>/gi, '\n[list]\n');
            bbcode = bbcode.replace(/<\/ul>/gi, '\n[/list]\n');
            bbcode = bbcode.replace(/<ol[^>]*>/gi, '\n[list=1]\n');
            bbcode = bbcode.replace(/<\/ol>/gi, '\n[/list]\n');
            bbcode = bbcode.replace(/<li[^>]*>(.*?)<\/li>/gis, '[*]$1\n');
            
            bbcode = bbcode.replace(/<blockquote[^>]*>(.*?)<\/blockquote>/gis, '[quote]$1[/quote]');
            
            bbcode = bbcode.replace(/<table[^>]*>/gi, '[table]');
            bbcode = bbcode.replace(/<\/table>/gi, '[/table]');
            bbcode = bbcode.replace(/<tr[^>]*>/gi, '[tr]');
            bbcode = bbcode.replace(/<\/tr>/gi, '[/tr]');
            bbcode = bbcode.replace(/<th[^>]*>(.*?)<\/th>/gis, '[td][b]$1[/b][/td]');
            bbcode = bbcode.replace(/<td[^>]*>(.*?)<\/td>/gis, '[td]$1[/td]');
            
            bbcode = bbcode.replace(/<code[^>]*>(.*?)<\/code>/gis, '[code]$1[/code]');
            
            bbcode = bbcode.replace(/<strong[^>]*><strong[^>]*>(.*?)<\/strong><\/strong>/gis, '[b]$1[/b]');
            bbcode = bbcode.replace(/<b[^>]*><b[^>]*>(.*?)<\/b><\/b>/gis, '[b]$1[/b]');
            bbcode = bbcode.replace(/<em[^>]*><em[^>]*>(.*?)<\/em><\/em>/gis, '[i]$1[/i]');
            bbcode = bbcode.replace(/<i[^>]*><i[^>]*>(.*?)<\/i><\/i>/gis, '[i]$1[/i]');
            bbcode = bbcode.replace(/<u[^>]*><u[^>]*>(.*?)<\/u><\/u>/gis, '[u]$1[/u]');
            bbcode = bbcode.replace(/<s[^>]*><s[^>]*>(.*?)<\/s><\/s>/gis, '[s]$1[/s]');
            
            bbcode = bbcode.replace(/<strong[^>]*>(.*?)<\/strong>/gis, '[b]$1[/b]');
            bbcode = bbcode.replace(/<b[^>]*>(.*?)<\/b>/gis, '[b]$1[/b]');
            bbcode = bbcode.replace(/<em[^>]*>(.*?)<\/em>/gis, '[i]$1[/i]');
            bbcode = bbcode.replace(/<i[^>]*>(.*?)<\/i>/gis, '[i]$1[/i]');
            bbcode = bbcode.replace(/<u[^>]*>(.*?)<\/u>/gis, '[u]$1[/u]');
            bbcode = bbcode.replace(/<s[^>]*>(.*?)<\/s>/gis, '[s]$1[/s]');
            bbcode = bbcode.replace(/<strike[^>]*>(.*?)<\/strike>/gis, '[s]$1[/s]');
            bbcode = bbcode.replace(/<del[^>]*>(.*?)<\/del>/gis, '[s]$1[/s]');
            
            bbcode = bbcode.replace(/<span[^>]*style=["'][^"']*font-size:\s*(\d+)px[^"']*["'][^>]*>(.*?)<\/span>/gis, '[size=$1]$2[/size]');
            
            bbcode = bbcode.replace(/<p[^>]*>/gi, '');
            bbcode = bbcode.replace(/<\/p>/gi, '\n\n');
            bbcode = bbcode.replace(/<br[^>]*\/?>/gi, '\n');
            bbcode = bbcode.replace(/<div[^>]*>/gi, '');
            bbcode = bbcode.replace(/<\/div>/gi, '\n');
            
            bbcode = bbcode.replace(/<[^>]*>/g, '');
            
            bbcode = bbcode.replace(/&lt;/g, '<');
            bbcode = bbcode.replace(/&gt;/g, '>');
            bbcode = bbcode.replace(/&amp;/g, '&');
            bbcode = bbcode.replace(/&quot;/g, '"');
            bbcode = bbcode.replace(/&#39;/g, "'");
            bbcode = bbcode.replace(/&nbsp;/g, ' ');
            
            bbcode = bbcode.replace(/\[b\]\[b\]/g, '[b]');
            bbcode = bbcode.replace(/\[\/b\]\[\/b\]/g, '[/b]');
            bbcode = bbcode.replace(/\[i\]\[i\]/g, '[i]');
            bbcode = bbcode.replace(/\[\/i\]\[\/i\]/g, '[/i]');
            bbcode = bbcode.replace(/\[u\]\[u\]/g, '[u]');
            bbcode = bbcode.replace(/\[\/u\]\[\/u\]/g, '[/u]');
            bbcode = bbcode.replace(/\[s\]\[s\]/g, '[s]');
            bbcode = bbcode.replace(/\[\/s\]\[\/s\]/g, '[/s]');
            
            bbcode = bbcode.replace(/(\[\/video\])(?!\n)/g, '$1\n');
            
            bbcode = bbcode.replace(/\n\s*\n\s*\n/g, '\n\n');
            bbcode = bbcode.replace(/^\s+|\s+$/g, '');
            bbcode = bbcode.trim();
            
            return bbcode;
        }

        function bbcodeToHtml(bbcode) {
            let html = bbcode;
            
            html = html.replace(/&/g, '&amp;');
            html = html.replace(/</g, '&lt;');
            html = html.replace(/>/g, '&gt;');
            
            // Обработка цвета текста и фона
            html = html.replace(/\[color=([^\]]+)\](.*?)\[\/color\]/gis, '<span style="color: $1;">$2</span>');
            html = html.replace(/\[bgcolor=([^\]]+)\](.*?)\[\/bgcolor\]/gis, '<span style="background-color: $1;">$2</span>');
            
            html = html.replace(/\[video width=([^\s\]]+) height=([^\s\]]+)\](https:\/\/(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+))\[\/video\]/g, 
                function(match, width, height, url, videoId) {
                    return `<div class="youtube-video" data-video-id="${videoId}" data-width="${width}" data-height="${height}"><iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe></div>`;
                });
            
            html = html.replace(/\[video\](https:\/\/(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+))\[\/video\]/g, 
                '<div class="youtube-video" data-video-id="$2" data-width="640" data-height="360"><iframe src="https://www.youtube.com/embed/$2" frameborder="0" allowfullscreen></iframe></div>');
            
            html = html.replace(/https:\/\/(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/g, '<div class="youtube-video" data-video-id="$1" data-width="640" data-height="360"><iframe src="https://www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe></div>');
            html = html.replace(/https:\/\/youtu\.be\/([a-zA-Z0-9_-]+)/g, '<div class="youtube-video" data-video-id="$1" data-width="640" data-height="360"><iframe src="https://www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe></div>');
            
            html = html.replace(/\[center\](.*?)\[\/center\]/gis, '<div class="text-center">$1</div>');
            html = html.replace(/\[right\](.*?)\[\/right\]/gis, '<div class="text-right">$1</div>');
            html = html.replace(/\[left\](.*?)\[\/left\]/gis, '<div class="text-left">$1</div>');
            
            html = html.replace(/\[align=center\](.*?)\[\/align\]/gis, '<div class="text-center">$1</div>');
            html = html.replace(/\[align=right\](.*?)\[\/align\]/gis, '<div class="text-right">$1</div>');
            html = html.replace(/\[align=left\](.*?)\[\/align\]/gis, '<div class="text-left">$1</div>');
            
            html = html.replace(/\[size=(\d+)\](.*?)\[\/size\]/gis, '<span style="font-size: $1px;">$2</span>');
            
            html = html.replace(/\[b\](.*?)\[\/b\]/gis, '<strong>$1</strong>');
            html = html.replace(/\[i\](.*?)\[\/i\]/gis, '<em>$1</em>');
            html = html.replace(/\[u\](.*?)\[\/u\]/gis, '<u>$1</u>');
            html = html.replace(/\[s\](.*?)\[\/s\]/gis, '<s>$1</s>');
            
            html = html.replace(/\[url=([^\]]+)\](.*?)\[\/url\]/gis, '<a href="$1" class="bb-link" target="_blank">$2</a>');
            html = html.replace(/\[url\](.*?)\[\/url\]/gis, '<a href="$1" class="bb-link" target="_blank">$1</a>');
            
            html = html.replace(/\[img\](.*?)\[\/img\]/gis, '<img src="$1" class="bb-image" alt="Изображение" onerror="this.style.border=\'2px dashed #ccc\'; this.style.padding=\'20px\'; this.textContent=\'❌ Ошибка загрузки изображения\';">');
            
            html = html.replace(/\[ul\]/gi, '<ul>');
            html = html.replace(/\[\/ul\]/gi, '</ul>');
            
            html = html.replace(/\[list=1\]/gi, '<ol>');
            html = html.replace(/\[list\]/gi, '<ul>');
            html = html.replace(/\[\/list\]/gi, '</ul>');
            html = html.replace(/\[\*\](.*?)(?=\n|\[\*\]|\[\/list\]|\[\/ul\]|$)/gis, '<li>$1</li>');
            
            html = html.replace(/\[quote\](.*?)\[\/quote\]/gis, '<blockquote>$1</blockquote>');
            
            html = html.replace(/\[table\]/gi, '<table>');
            html = html.replace(/\[\/table\]/gi, '</table>');
            html = html.replace(/\[tr\]/gi, '<tr>');
            html = html.replace(/\[\/tr\]/gi, '</tr>');
            html = html.replace(/\[td\](.*?)\[\/td\]/gis, '<td>$1</td>');
            
            html = html.replace(/\[code\](.*?)\[\/code\]/gis, '<code>$1</code>');
            
            html = html.replace(/\n\n/g, '</p><p>');
            html = html.replace(/\n/g, '<br>');
            html = '<p>' + html + '</p>';
            
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p>\s*<\/p>/g, '');
            html = html.replace(/<p>(<table>.*?<\/table>)<\/p>/gis, '$1');
            html = html.replace(/<p>(<blockquote>.*?<\/blockquote>)<\/p>/gis, '$1');
            html = html.replace(/<p>(<ul>.*?<\/ul>)<\/p>/gis, '$1');
            html = html.replace(/<p>(<ol>.*?<\/ol>)<\/p>/gis, '$1');
            html = html.replace(/<p>(<img[^>]*>)<\/p>/gi, '$1');
            html = html.replace(/<p>(<div[^>]*>.*?<\/div>)<\/p>/gis, '$1');
            
            return html;
        }

        function updateBBCode() {
            if (isUpdating) return;
            isUpdating = true;
            
            const visualEditor = document.getElementById('visualEditor');
            const bbcodeEditor = document.getElementById('bbcodeEditor');
            
            const html = visualEditor.innerHTML;
            const bbcode = htmlToBBCode(html);
            bbcodeEditor.value = bbcode;
            
            updateCharCount();
            updateBBTagCount();
            isUpdating = false;
        }

        function updateVisual() {
            if (isUpdating) return;
            isUpdating = true;
            
            const visualEditor = document.getElementById('visualEditor');
            const bbcodeEditor = document.getElementById('bbcodeEditor');
            
            const bbcode = bbcodeEditor.value;
            const html = bbcodeToHtml(bbcode);
            visualEditor.innerHTML = html;
            
            updateCharCount();
            updateBBTagCount();
            updateImageCount();
            isUpdating = false;
        }

        function updateCharCount() {
            const charCount = document.getElementById('charCount');
            if (currentMode === 'visual') {
                const visualEditor = document.getElementById('visualEditor');
                charCount.textContent = visualEditor.textContent.length;
            } else {
                const bbcodeEditor = document.getElementById('bbcodeEditor');
                charCount.textContent = bbcodeEditor.value.length;
            }
        }

        function updateBBTagCount() {
            const bbtagCount = document.getElementById('bbtagCount');
            const bbcodeEditor = document.getElementById('bbcodeEditor');
            const matches = bbcodeEditor.value.match(/\[[^\]]+\]/g);
            bbtagCount.textContent = matches ? matches.length : 0;
        }

        function showLinkModal() {
            const selection = window.getSelection().toString();
            if (selection) {
                document.getElementById('linkText').value = selection;
            }
            saveSelection();
            document.getElementById('linkModal').style.display = 'block';
            document.getElementById('linkText').focus();
        }

        function closeLinkModal() {
            document.getElementById('linkModal').style.display = 'none';
        }

        function insertLink() {
            const text = document.getElementById('linkText').value;
            const url = document.getElementById('linkUrl').value;
            
            if (text && url) {
                const visualEditor = document.getElementById('visualEditor');
                visualEditor.focus();
                restoreSelection();
                
                const linkHtml = `<a href="${url}" class="bb-link" target="_blank">${text}</a>`;
                
                document.execCommand('insertHTML', false, linkHtml);
                
                closeLinkModal();
                document.getElementById('linkText').value = '';
                document.getElementById('linkUrl').value = '';
                
                setTimeout(updateBBCode, 50);
            } else {
                alert('Пожалуйста, заполните все поля');
            }
        }

        function showImageModal() {
            saveSelection();
            document.getElementById('imageModal').style.display = 'block';
            document.getElementById('imageUrl').focus();
        }

        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        function insertImage() {
            const url = document.getElementById('imageUrl').value;
            const alt = document.getElementById('imageAlt').value || 'Изображение';
            
            if (url) {
                const visualEditor = document.getElementById('visualEditor');
                visualEditor.focus();
                restoreSelection();
                
                const imgHtml = `<img src="${url}" class="bb-image" alt="${alt}" onerror="this.style.border='2px dashed #ccc'; this.style.padding='20px'; this.textContent='❌ Ошибка загрузки изображения';">`;
                
                document.execCommand('insertHTML', false, imgHtml);
                
                closeImageModal();
                document.getElementById('imageUrl').value = '';
                document.getElementById('imageAlt').value = '';
                
                setTimeout(() => {
                    updateBBCode();
                    updateImageCount();
                }, 50);
            } else {
                alert('Пожалуйста, введите URL изображения');
            }
        }

        function showVideoModal() {
            saveSelection();
            document.getElementById('videoModal').style.display = 'block';
            document.getElementById('videoUrl').focus();
        }

        function closeVideoModal() {
            document.getElementById('videoModal').style.display = 'none';
        }

        function insertVideo() {
            const url = document.getElementById('videoUrl').value;
            const width = document.getElementById('videoWidth').value;
            const height = document.getElementById('videoHeight').value;
            
            if (url) {
                let videoId = '';
                const youtubeRegex1 = /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/;
                const youtubeRegex2 = /(?:https?:\/\/)?(?:www\.)?youtu\.be\/([a-zA-Z0-9_-]+)/;
                
                const match1 = url.match(youtubeRegex1);
                const match2 = url.match(youtubeRegex2);
                
                if (match1) {
                    videoId = match1[1];
                } else if (match2) {
                    videoId = match2[1];
                }
                
                if (videoId) {
                    const visualEditor = document.getElementById('visualEditor');
                    visualEditor.focus();
                    restoreSelection();
                    
                    const actualHeight = height === 'auto' ? Math.round(parseInt(width) * 9 / 16) : height;
                    const videoHtml = `<div class="youtube-video" data-video-id="${videoId}" data-width="${width}" data-height="${actualHeight}"><iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe></div>`;
                    
                    document.execCommand('insertHTML', false, videoHtml);
                    
                    closeVideoModal();
                    document.getElementById('videoUrl').value = '';
                    
                    setTimeout(updateBBCode, 50);
                } else {
                    alert('Пожалуйста, введите корректную ссылку YouTube');
                }
            } else {
                alert('Пожалуйста, введите URL видео');
            }
        }

        function insertQuote() {
            const selection = window.getSelection().toString();
            const quoteText = selection || 'Введите текст цитаты здесь';
            const quoteHtml = `<blockquote>${quoteText}</blockquote>`;
            execCommand('insertHTML', quoteHtml);
        }

        function showTableModal() {
            saveSelection();
            document.getElementById('tableModal').style.display = 'block';
        }

        function closeTableModal() {
            document.getElementById('tableModal').style.display = 'none';
        }

        function insertTable() {
            const rows = parseInt(document.getElementById('tableRows').value);
            const cols = parseInt(document.getElementById('tableCols').value);
            
            const visualEditor = document.getElementById('visualEditor');
            visualEditor.focus();
            restoreSelection();
            
            let tableHtml = '<table>';
            
            tableHtml += '<tr>';
            for (let j = 0; j < cols; j++) {
                tableHtml += `<th>Заголовок ${j + 1}</th>`;
            }
            tableHtml += '</tr>';
            
            for (let i = 1; i < rows; i++) {
                tableHtml += '<tr>';
                for (let j = 0; j < cols; j++) {
                    tableHtml += `<td>Ячейка ${i + 1}.${j + 1}</td>`;
                }
                tableHtml += '</tr>';
            }
            
            tableHtml += '</table>';
            
            document.execCommand('insertHTML', false, tableHtml);
            closeTableModal();
            setTimeout(updateBBCode, 50);
        }

        function insertCode() {
            const selection = window.getSelection().toString();
            const codeText = selection || 'код здесь';
            const codeHtml = `<code>${codeText}</code>`;
            execCommand('insertHTML', codeHtml);
        }

        function clearFormatting() {
            execCommand('removeFormat');
            setTimeout(() => {
                updateBBCode();
                updateImageCount();
            }, 50);
        }

        function clearEditor() {
            if (confirm('Вы уверены, что хотите очистить весь редактор?')) {
                document.getElementById('visualEditor').innerHTML = '';
                document.getElementById('bbcodeEditor').value = '';
                updateCharCount();
                updateBBTagCount();
                updateImageCount();
            }
        }

        function removeSize() {
            const bbcodeEditor = document.getElementById('bbcodeEditor');
            let bbcode = bbcodeEditor.value;
            
            bbcode = bbcode.replace(/\[size=\d+\](.*?)\[\/size\]/gis, '$1');
            
            bbcodeEditor.value = bbcode;
            
            if (currentMode === 'visual') {
                updateVisual();
            } else {
                updateCharCount();
                updateBBTagCount();
            }
            
            showNotification('Теги [size] удалены из BB-кода');
        }

        function removeColors() {
            const bbcodeEditor = document.getElementById('bbcodeEditor');
            let bbcode = bbcodeEditor.value;
            
            bbcode = bbcode.replace(/\[color=[^\]]+\](.*?)\[\/color\]/gis, '$1');
            bbcode = bbcode.replace(/\[color\](.*?)\[\/color\]/gis, '$1');
            
            bbcode = bbcode.replace(/\[bgcolor=[^\]]+\](.*?)\[\/bgcolor\]/gis, '$1');
            bbcode = bbcode.replace(/\[bgcolor\](.*?)\[\/bgcolor\]/gis, '$1');
            
            bbcodeEditor.value = bbcode;
            
            if (currentMode === 'visual') {
                updateVisual();
            } else {
                updateCharCount();
                updateBBTagCount();
            }
            
            showNotification('Все цветовые теги [color] и [bgcolor] удалены из BB-кода');
        }

        function convertToMyBB() {
            const bbcodeEditor = document.getElementById('bbcodeEditor');
            let bbcode = bbcodeEditor.value;
            
            bbcode = bbcode.replace(/\[list\]/gi, '[ul]');
            bbcode = bbcode.replace(/\[list=1\]/gi, '[ul]');
            bbcode = bbcode.replace(/\[\/list\]/gi, '[/ul]');
            
            bbcode = bbcode.replace(/\[\*\]([^\n\[]+)/gi, '$1');
            
            bbcode = bbcode.replace(/\[right\](.*?)\[\/right\]/gis, '[align=right]$1[/align]');
            bbcode = bbcode.replace(/\[center\](.*?)\[\/center\]/gis, '[align=center]$1[/align]');
            
            bbcodeEditor.value = bbcode;
            
            if (currentMode === 'visual') {
                updateVisual();
            } else {
                updateCharCount();
                updateBBTagCount();
            }
            
            showNotification('Конвертация в формат MyBB выполнена');
        }
        
        function removeLists() {
            const bbcodeEditor = document.getElementById('bbcodeEditor');
            let bbcode = bbcodeEditor.value;
            
            bbcode = bbcode.replace(/\[list[^\]]*\]/gi, '');
            bbcode = bbcode.replace(/\[\/list\]/gi, '');
            bbcode = bbcode.replace(/\[ul\]/gi, '');
            bbcode = bbcode.replace(/\[\/ul\]/gi, '');
            bbcode = bbcode.replace(/\[\*\]/gi, '');
            
            bbcode = bbcode.replace(/\n\s*\n\s*\n/g, '\n\n');
            
            bbcodeEditor.value = bbcode;
            
            if (currentMode === 'visual') {
                updateVisual();
            } else {
                updateCharCount();
                updateBBTagCount();
            }
            
            showNotification('Все списки удалены из BB-кода');
        }
        
        function copyBBCode() {
            const bbcodeEditor = document.getElementById('bbcodeEditor');
            const bbcode = bbcodeEditor.value;
            
            if (!bbcode.trim()) {
                showNotification('BB-код пуст, нечего копировать', true);
                return;
            }
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(bbcode).then(() => {
                    showNotification('BB-код скопирован в буфер обмена');
                }).catch(() => {
                    fallbackCopyTextToClipboard(bbcode);
                });
            } else {
                fallbackCopyTextToClipboard(bbcode);
            }
        }
        
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showNotification('BB-код скопирован в буфер обмена');
                } else {
                    showNotification('Не удалось скопировать BB-код', true);
                }
            } catch (err) {
                showNotification('Ошибка при копировании BB-кода', true);
            }
            
            document.body.removeChild(textArea);
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('visualEditor').innerHTML = '';
            updateBBCode();
            updateImageCount();
            
            // КЛЮЧЕВОЕ ИСПРАВЛЕНИЕ: Добавляем обработчики для пикеров цвета
            const textColorPicker = document.getElementById('textColorPicker');
            const bgColorPicker = document.getElementById('bgColorPicker');
            
            // Сохраняем выделение перед открытием пикера
            document.getElementById('visualEditor').addEventListener('mouseup', saveSelection);
            document.getElementById('visualEditor').addEventListener('keyup', saveSelection);
            
            // Применяем цвет при изменении
            textColorPicker.addEventListener('change', function() {
                changeTextColor(this.value);
            });
            
            textColorPicker.addEventListener('input', function() {
                changeTextColor(this.value);
            });
            
            bgColorPicker.addEventListener('change', function() {
                changeBackgroundColor(this.value);
            });
            
            bgColorPicker.addEventListener('input', function() {
                changeBackgroundColor(this.value);
            });
            
            window.onclick = function(event) {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }

            document.getElementById('linkUrl').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    insertLink();
                }
            });

            document.getElementById('imageUrl').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    insertImage();
                }
            });

            document.getElementById('videoUrl').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    insertVideo();
                }
            });
        });
    </script>
</body>
</html>