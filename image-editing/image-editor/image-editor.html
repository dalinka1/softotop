<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Профессиональный редактор изображений PRO</title>
 <link rel="stylesheet" href="/menu/menu.css">
  <script src="/menu/menu.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .upload-section {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 30px;
        }

        .upload-section:hover {
            background: #eef0ff;
            border-color: #764ba2;
        }

        .upload-section.drag-over {
            background: #e0e5ff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
        }

        /* Новый раздел предпросмотра */
        .preview-section {
            display: none;
            background: #f8f9ff;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid #e0e5ff;
        }

        .preview-section.active {
            display: block;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .preview-header h2 {
            color: #667eea;
            font-size: 1.8em;
        }

        .preview-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Новая компоновка: превью слева, фильтры справа */
        .preview-with-filters {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .comparison-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .comparison-panel h3 {
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        .image-wrapper {
            position: relative;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-wrapper img,
        .image-wrapper canvas {
            max-width: 100%;
            max-height: 600px;
            object-fit: contain;
        }

        .image-info-panel {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e0e5ff;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: bold;
            color: #667eea;
        }

        /* Панель фильтров рядом с превью */
        .filters-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-height: 800px;
            overflow-y: auto;
        }

        .filters-panel h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
            position: sticky;
            top: 0;
            background: white;
            padding: 10px 0;
            z-index: 10;
        }

        .controls-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e0e5ff;
        }

        .control-group h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .control-item {
            margin-bottom: 15px;
        }

        .control-item label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
            font-size: 0.9em;
        }

        .control-item input[type="number"],
        .control-item input[type="text"],
        .control-item input[type="range"],
        .control-item select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e5ff;
            border-radius: 8px;
            font-size: 1em;
        }

        .control-item input[type="range"] {
            padding: 0;
        }

        .control-item input[type="color"] {
            width: 100%;
            height: 50px;
            border: 2px solid #e0e5ff;
            border-radius: 8px;
            cursor: pointer;
        }

        .control-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .range-value {
            display: inline-block;
            margin-left: 10px;
            color: #667eea;
            font-weight: bold;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .image-card {
            background: #f8f9ff;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            position: relative;
        }

        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .image-card.selected {
            border: 3px solid #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }

        .image-preview {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background: white;
            padding: 10px;
            cursor: pointer;
        }

        .image-info {
            padding: 15px;
        }

        .image-name {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .image-size {
            color: #888;
            font-size: 0.9em;
        }

        .image-actions {
            padding: 10px 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
            flex: 1;
            min-width: 80px;
        }

        .stats {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .stat-item {
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 2px solid #e0e5ff;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #888;
            margin-top: 5px;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .filter-btn {
            padding: 8px 15px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .crop-preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .preset-btn {
            padding: 8px 15px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .preset-btn:hover {
            background: #667eea;
            color: white;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 30px;
        }

        .hidden {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e5ff;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            background: #667eea;
            color: white;
            border-radius: 15px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .badge.success {
            background: #4facfe;
        }

        .slider-container {
            position: relative;
            margin-top: 10px;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.8em;
            color: #888;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .quick-action-btn {
            padding: 15px 25px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            min-width: 120px;
        }

        .quick-action-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-3px);
        }

        .quick-action-icon {
            font-size: 2em;
        }

        /* Стили для точной обрезки */
        .crop-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .crop-side-control {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e0e5ff;
        }

        .crop-side-control h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 0.9em;
            text-align: center;
        }

        .crop-side-control input {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e5ff;
            border-radius: 5px;
            text-align: center;
        }

        .crop-preview-info {
            background: #f0f8ff;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85em;
            color: #667eea;
            text-align: center;
            margin-top: 10px;
        }

        /* Предупреждение об обрезке */
        .crop-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
            text-align: center;
        }

        input[type="file"] {
            display: none;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .controls-panel {
                grid-template-columns: 1fr;
            }

            .images-grid {
                grid-template-columns: 1fr;
            }

            .comparison-container {
                grid-template-columns: 1fr;
            }

            .preview-with-filters {
                grid-template-columns: 1fr;
            }

            .crop-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Анимации */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-in {
            animation: slideIn 0.5s ease-out;
        }

        /* Кастомный скроллбар для панели фильтров */
        .filters-panel::-webkit-scrollbar {
            width: 8px;
        }

        .filters-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .filters-panel::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .filters-panel::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎨 Профессиональный редактор изображений PRO</h1>
            <p>Пакетная обработка • Живой предпросмотр • Водяные знаки • Фильтры • Точная обрезка • Множество форматов</p>
        </div>

        <div class="main-content">
            <!-- Статистика -->
            <div class="stats hidden" id="stats">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalImages">0</div>
                        <div class="stat-label">Изображений</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalSize">0 MB</div>
                        <div class="stat-label">Общий размер</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="processedImages">0</div>
                        <div class="stat-label">Обработано</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="selectedImages">0</div>
                        <div class="stat-label">Выбрано</div>
                    </div>
                </div>
            </div>

            <!-- Загрузка файлов -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon pulse">📁</div>
                <h2>Перетащите изображения сюда</h2>
                <p>или</p>
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    Выберите файлы
                </button>
                <input type="file" id="fileInput" multiple accept="image/*">
                <p style="margin-top: 20px; color: #888;">
                    Поддерживаемые форматы: JPG, PNG, WebP, GIF, BMP
                </p>
            </div>

            <!-- Быстрые действия -->
            <div class="quick-actions hidden" id="quickActions">
                <button class="quick-action-btn" onclick="selectAllImages()">
                    <span class="quick-action-icon">✅</span>
                    <span>Выбрать всё</span>
                </button>
                <button class="quick-action-btn" onclick="deselectAllImages()">
                    <span class="quick-action-icon">❌</span>
                    <span>Снять выбор</span>
                </button>
                <button class="quick-action-btn" onclick="showLivePreview()">
                    <span class="quick-action-icon">👁️</span>
                    <span>Предпросмотр</span>
                </button>
                <button class="quick-action-btn" onclick="resetAllSettings()">
                    <span class="quick-action-icon">🔄</span>
                    <span>Сброс настроек</span>
                </button>
                <button class="quick-action-btn" onclick="autoEnhance()">
                    <span class="quick-action-icon">✨</span>
                    <span>Авто-улучшение</span>
                </button>
            </div>

            <!-- Раздел живого предпросмотра -->
            <div class="preview-section" id="previewSection">
                <div class="preview-header">
                    <h2>🔍 Живой предпросмотр</h2>
                    <div class="preview-controls">
                        <button class="btn btn-small btn-success" onclick="applyToSelected()">
                            ✓ Применить к выбранным
                        </button>
                        <button class="btn btn-small btn-secondary" onclick="hidePreview()">
                            ✕ Закрыть
                        </button>
                    </div>
                </div>
                
                <div class="preview-with-filters">
                    <!-- Левая часть: Сравнение изображений -->
                    <div class="comparison-container">
                        <div class="comparison-panel">
                            <h3>📷 Оригинал</h3>
                            <div class="image-wrapper">
                                <img id="originalImage" alt="Оригинал">
                            </div>
                            <div class="image-info-panel" id="originalInfo"></div>
                        </div>
                        
                        <div class="comparison-panel">
                            <h3>✨ После обработки</h3>
                            <div class="image-wrapper">
                                <canvas id="previewCanvas"></canvas>
                            </div>
                            <div class="image-info-panel" id="processedInfo"></div>
                        </div>
                    </div>

                    <!-- Правая часть: Фильтры и коррекция -->
                    <div class="filters-panel">
                        <h3>🎨 Фильтры и коррекция</h3>
                        
                        <div class="control-item">
                            <label>Яркость: <span class="range-value" id="brightnessValue">100</span>%</label>
                            <input type="range" id="brightnessRange" min="0" max="200" value="100" oninput="updateLivePreview()">
                        </div>
                        
                        <div class="control-item">
                            <label>Контраст: <span class="range-value" id="contrastValue">100</span>%</label>
                            <input type="range" id="contrastRange" min="0" max="200" value="100" oninput="updateLivePreview()">
                        </div>
                        
                        <div class="control-item">
                            <label>Насыщенность: <span class="range-value" id="saturationValue">100</span>%</label>
                            <input type="range" id="saturationRange" min="0" max="200" value="100" oninput="updateLivePreview()">
                        </div>
                        
                        <div class="control-item">
                            <label>Оттенок: <span class="range-value" id="hueValue">0</span>°</label>
                            <input type="range" id="hueRange" min="0" max="360" value="0" oninput="updateLivePreview()">
                        </div>
                        
                        <div class="control-item">
                            <label>Размытие: <span class="range-value" id="blurValue">0</span>px</label>
                            <input type="range" id="blurRange" min="0" max="20" value="0" oninput="updateLivePreview()">
                        </div>
                        
                        <div class="control-item">
                            <label>Резкость: <span class="range-value" id="sharpnessValue">0</span></label>
                            <input type="range" id="sharpnessRange" min="0" max="10" value="0" oninput="updateLivePreview()">
                        </div>
                        
                        <div class="control-item">
                            <label>Виньетка: <span class="range-value" id="vignetteValue">0</span>%</label>
                            <input type="range" id="vignetteRange" min="0" max="100" value="0" oninput="updateLivePreview()">
                        </div>
                        
                        <div class="control-item">
                            <label>Стилистические фильтры:</label>
                            <div class="filter-buttons">
                                <button class="filter-btn active" onclick="setFilter('none')">Оригинал</button>
                                <button class="filter-btn" onclick="setFilter('grayscale')">ЧБ</button>
                                <button class="filter-btn" onclick="setFilter('sepia')">Сепия</button>
                                <button class="filter-btn" onclick="setFilter('invert')">Негатив</button>
                                <button class="filter-btn" onclick="setFilter('vintage')">Винтаж</button>
                                <button class="filter-btn" onclick="setFilter('cold')">Холодный</button>
                                <button class="filter-btn" onclick="setFilter('warm')">Теплый</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Панель управления -->
            <div class="controls-panel hidden" id="controlsPanel">
                <!-- Точная обрезка -->
                <div class="control-group">
                    <h3>✂️ Точная обрезка</h3>
                    <div class="control-item">
                        <label>
                            <input type="checkbox" id="enablePreciseCrop" onchange="updateLivePreview()"> Включить точную обрезку
                        </label>
                    </div>
                    <div class="crop-grid">
                        <div class="crop-side-control">
                            <h4>⬆️ Сверху</h4>
                            <input type="number" id="cropTop" value="0" min="0" placeholder="px" oninput="updateLivePreview()">
                        </div>
                        <div class="crop-side-control">
                            <h4>⬇️ Снизу</h4>
                            <input type="number" id="cropBottom" value="0" min="0" placeholder="px" oninput="updateLivePreview()">
                        </div>
                        <div class="crop-side-control">
                            <h4>⬅️ Слева</h4>
                            <input type="number" id="cropLeft" value="0" min="0" placeholder="px" oninput="updateLivePreview()">
                        </div>
                        <div class="crop-side-control">
                            <h4>➡️ Справа</h4>
                            <input type="number" id="cropRight" value="0" min="0" placeholder="px" oninput="updateLivePreview()">
                        </div>
                    </div>
                    <div class="crop-preview-info">
                        <div id="cropInfo">Информация об обрезке появится здесь</div>
                    </div>
                    <div id="cropWarning" class="crop-warning hidden">
                        ⚠️ Внимание! Значения обрезки превышают размеры изображения
                    </div>
                    <div class="control-item">
                        <button class="btn btn-small btn-warning" onclick="resetCropValues()">🔄 Сбросить обрезку</button>
                        <button class="btn btn-small btn-info" onclick="autoCropWhitespace()">✨ Авто-обрезка</button>
                    </div>
                </div>

                <!-- Обрезка и размер -->
                <div class="control-group">
                    <h3>📐 Размер и пропорции</h3>
                    <div class="control-item">
                        <label>Ширина (px):</label>
                        <input type="number" id="cropWidth" value="1920" min="1" oninput="updateLivePreview()">
                    </div>
                    <div class="control-item">
                        <label>Высота (px):</label>
                        <input type="number" id="cropHeight" value="1080" min="1" oninput="updateLivePreview()">
                    </div>
                    <div class="control-item">
                        <label>Пресеты:</label>
                        <div class="crop-preset-buttons">
                            <button class="preset-btn" onclick="setCropPreset(1920, 1080)">Full HD</button>
                            <button class="preset-btn" onclick="setCropPreset(1280, 720)">HD</button>
                            <button class="preset-btn" onclick="setCropPreset(1080, 1080)">Instagram</button>
                            <button class="preset-btn" onclick="setCropPreset(1200, 630)">Facebook</button>
                            <button class="preset-btn" onclick="setCropPreset(1080, 1920)">Stories</button>
                            <button class="preset-btn" onclick="setCropPreset(800, 600)">4:3</button>
                        </div>
                    </div>
                    <div class="control-item">
                        <label>
                            <input type="checkbox" id="maintainAspect" onchange="updateLivePreview()"> Сохранять пропорции
                        </label>
                    </div>
                </div>

                <!-- Изменение размера и поворот -->
                <div class="control-group">
                    <h3>🔄 Масштаб и поворот</h3>
                    <div class="control-item">
                        <label>Масштаб (%): <span class="range-value" id="scaleValue">100</span></label>
                        <div class="slider-container">
                            <input type="range" id="scaleRange" min="10" max="300" value="100" oninput="updateLivePreview()">
                            <div class="slider-labels">
                                <span>10%</span>
                                <span>100%</span>
                                <span>300%</span>
                            </div>
                        </div>
                    </div>
                    <div class="control-item">
                        <label>Качество: <span class="range-value" id="qualityValue">92</span>%</label>
                        <div class="slider-container">
                            <input type="range" id="qualityRange" min="1" max="100" value="92" oninput="updateLivePreview()">
                            <div class="slider-labels">
                                <span>Низкое</span>
                                <span>Среднее</span>
                                <span>Высокое</span>
                            </div>
                        </div>
                    </div>
                    <div class="control-item">
                        <label>Поворот:</label>
                        <div class="crop-preset-buttons">
                            <button class="preset-btn" onclick="setRotation(0)">0°</button>
                            <button class="preset-btn" onclick="setRotation(90)">90°</button>
                            <button class="preset-btn" onclick="setRotation(180)">180°</button>
                            <button class="preset-btn" onclick="setRotation(270)">270°</button>
                        </div>
                    </div>
                    <div class="control-item">
                        <label>
                            <input type="checkbox" id="flipHorizontal" onchange="updateLivePreview()"> Отразить горизонтально
                        </label>
                    </div>
                    <div class="control-item">
                        <label>
                            <input type="checkbox" id="flipVertical" onchange="updateLivePreview()"> Отразить вертикально
                        </label>
                    </div>
                </div>

                <!-- Водяной знак -->
                <div class="control-group">
                    <h3>💧 Водяной знак</h3>
                    <div class="control-item">
                        <label>Текст водяного знака:</label>
                        <input type="text" id="watermarkText" placeholder="© Ваш текст" oninput="updateLivePreview()">
                    </div>
                    <div class="control-item">
                        <label>Размер шрифта: <span class="range-value" id="fontSizeValue">40</span></label>
                        <input type="range" id="fontSizeRange" min="10" max="150" value="40" oninput="updateLivePreview()">
                    </div>
                    <div class="control-item">
                        <label>Цвет текста:</label>
                        <input type="color" id="watermarkColor" value="#ffffff" onchange="updateLivePreview()">
                    </div>
                    <div class="control-item">
                        <label>Прозрачность: <span class="range-value" id="opacityValue">60</span>%</label>
                        <input type="range" id="opacityRange" min="0" max="100" value="60" oninput="updateLivePreview()">
                    </div>
                    <div class="control-item">
                        <label>Позиция:</label>
                        <select id="watermarkPosition" onchange="updateLivePreview()">
                            <option value="center">По центру</option>
                            <option value="top-left">Верх-лево</option>
                            <option value="top-center">Верх-центр</option>
                            <option value="top-right">Верх-право</option>
                            <option value="center-left">Центр-лево</option>
                            <option value="center-right">Центр-право</option>
                            <option value="bottom-left">Низ-лево</option>
                            <option value="bottom-center">Низ-центр</option>
                            <option value="bottom-right">Низ-право</option>
                            <option value="tiled">Повторяющийся</option>
                        </select>
                    </div>
                    <div class="control-item">
                        <label>
                            <input type="checkbox" id="watermarkBackground" checked onchange="updateLivePreview()"> Подложка под текст
                        </label>
                    </div>
                    <div class="control-item">
                        <label>Цвет подложки:</label>
                        <input type="color" id="watermarkBgColor" value="#000000" onchange="updateLivePreview()">
                    </div>
                    <div class="control-item">
                        <label>Прозрачность подложки: <span class="range-value" id="bgOpacityValue">50</span>%</label>
                        <input type="range" id="bgOpacityRange" min="0" max="100" value="50" oninput="updateLivePreview()">
                    </div>
                    <div class="control-item">
                        <label>Отступ подложки: <span class="range-value" id="bgPaddingValue">10</span>px</label>
                        <input type="range" id="bgPaddingRange" min="0" max="50" value="10" oninput="updateLivePreview()">
                    </div>
                    <div class="control-item">
                        <label>Изображение водяного знака:</label>
                        <input type="file" id="watermarkImageInput" accept="image/*" style="display: block;" onchange="loadWatermarkImage()">
                    </div>
                    <div class="control-item">
                        <label>
                            <input type="checkbox" id="watermarkShadow" onchange="updateLivePreview()"> Добавить тень
                        </label>
                    </div>
                </div>

                <!-- Рамки и границы -->
                <div class="control-group">
                    <h3>🖼️ Рамки и границы</h3>
                    <div class="control-item">
                        <label>Толщина рамки: <span class="range-value" id="borderWidthValue">0</span>px</label>
                        <input type="range" id="borderWidthRange" min="0" max="50" value="0" oninput="updateLivePreview()">
                    </div>
                    <div class="control-item">
                        <label>Цвет рамки:</label>
                        <input type="color" id="borderColor" value="#000000" onchange="updateLivePreview()">
                    </div>
                    <div class="control-item">
                        <label>Скругление углов: <span class="range-value" id="borderRadiusValue">0</span>px</label>
                        <input type="range" id="borderRadiusRange" min="0" max="100" value="0" oninput="updateLivePreview()">
                    </div>
                    <div class="control-item">
                        <label>Тень: <span class="range-value" id="shadowValue">0</span>px</label>
                        <input type="range" id="shadowRange" min="0" max="50" value="0" oninput="updateLivePreview()">
                    </div>
                </div>

                <!-- Формат экспорта -->
                <div class="control-group">
                    <h3>💾 Экспорт</h3>
                    <div class="control-item">
                        <label>Формат:</label>
                        <select id="exportFormat" onchange="updateLivePreview()">
                            <option value="image/jpeg">JPEG (.jpg)</option>
                            <option value="image/png">PNG (.png)</option>
                            <option value="image/webp">WebP (.webp)</option>
                        </select>
                    </div>
                    <div class="control-item">
                        <label>Префикс имени файла:</label>
                        <input type="text" id="filePrefix" placeholder="edited_" value="edited_">
                    </div>
                    <div class="control-item">
                        <label>Суффикс имени файла:</label>
                        <input type="text" id="fileSuffix" placeholder="">
                    </div>
                </div>
            </div>

            <!-- Прогресс -->
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>

            <!-- Сетка изображений -->
            <div class="images-grid" id="imagesGrid"></div>

            <!-- Кнопки действий -->
            <div class="action-buttons hidden" id="actionButtons">
                <button class="btn btn-success" onclick="processSelectedImages()">
                    🚀 Обработать выбранные
                </button>
                <button class="btn btn-info" onclick="processAllImages()">
                    ⚡ Обработать все
                </button>
                <button class="btn btn-secondary" onclick="downloadSelected()">
                    💾 Скачать выбранные
                </button>
                <button class="btn btn-secondary" onclick="downloadAll()">
                    📦 Скачать все (ZIP)
                </button>
                <button class="btn btn-warning" onclick="clearAll()">
                    🗑️ Очистить всё
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        let uploadedImages = [];
        let processedImages = [];
        let watermarkImage = null;
        let currentRotation = 0;
        let currentFilter = 'none';
        let selectedImageIndex = -1;
        let selectedIndices = new Set();

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            updateRangeValues();
        });

        function initializeEventListeners() {
            const uploadSection = document.getElementById('uploadSection');
            const fileInput = document.getElementById('fileInput');

            // Drag & Drop
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('drag-over');
            });

            uploadSection.addEventListener('dragleave', () => {
                uploadSection.classList.remove('drag-over');
            });

            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });

            // File input
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            // Range обновления
            document.querySelectorAll('input[type="range"]').forEach(range => {
                range.addEventListener('input', updateRangeValues);
            });
        }

        function updateRangeValues() {
            const ranges = {
                'scaleValue': 'scaleRange',
                'qualityValue': 'qualityRange',
                'fontSizeValue': 'fontSizeRange',
                'opacityValue': 'opacityRange',
                'bgOpacityValue': 'bgOpacityRange',
                'bgPaddingValue': 'bgPaddingRange',
                'brightnessValue': 'brightnessRange',
                'contrastValue': 'contrastRange',
                'saturationValue': 'saturationRange',
                'hueValue': 'hueRange',
                'blurValue': 'blurRange',
                'sharpnessValue': 'sharpnessRange',
                'vignetteValue': 'vignetteRange',
                'borderWidthValue': 'borderWidthRange',
                'borderRadiusValue': 'borderRadiusRange',
                'shadowValue': 'shadowRange'
            };

            for (let [valueId, rangeId] of Object.entries(ranges)) {
                const valueEl = document.getElementById(valueId);
                const rangeEl = document.getElementById(rangeId);
                if (valueEl && rangeEl) {
                    valueEl.textContent = rangeEl.value;
                }
            }
        }

        function handleFiles(files) {
            const fileArray = Array.from(files);
            
            fileArray.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            uploadedImages.push({
                                file: file,
                                image: img,
                                name: file.name,
                                size: file.size,
                                processed: false,
                                selected: false
                            });
                            renderImageCard(uploadedImages.length - 1);
                            updateStats();
                            showControls();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function renderImageCard(index) {
            const imageData = uploadedImages[index];
            const grid = document.getElementById('imagesGrid');
            
            const card = document.createElement('div');
            card.className = 'image-card slide-in';
            card.id = `card-${index}`;
            if (imageData.selected) {
                card.classList.add('selected');
            }
            
            card.innerHTML = `
                <img src="${imageData.image.src}" alt="${imageData.name}" class="image-preview" onclick="toggleSelect(${index})">
                <div class="image-info">
                    <div class="image-name" title="${imageData.name}">${imageData.name}</div>
                    <div class="image-size">${(imageData.size / 1024).toFixed(2)} KB • ${imageData.image.width}x${imageData.image.height}px</div>
                    ${imageData.processed ? '<span class="badge success">Обработано</span>' : ''}
                </div>
                <div class="image-actions">
                    <button class="btn btn-small" onclick="previewImage(${index})">👁️ Превью</button>
                    <button class="btn btn-small" onclick="toggleSelect(${index})">${imageData.selected ? '✓' : '☐'}</button>
                    <button class="btn btn-small btn-danger" onclick="removeImage(${index})">🗑️</button>
                </div>
            `;
            
            grid.appendChild(card);
        }

        function toggleSelect(index) {
            uploadedImages[index].selected = !uploadedImages[index].selected;
            if (uploadedImages[index].selected) {
                selectedIndices.add(index);
            } else {
                selectedIndices.delete(index);
            }
            renderImagesGrid();
            updateStats();
        }

        function selectAllImages() {
            uploadedImages.forEach((img, index) => {
                img.selected = true;
                selectedIndices.add(index);
            });
            renderImagesGrid();
            updateStats();
        }

        function deselectAllImages() {
            uploadedImages.forEach(img => img.selected = false);
            selectedIndices.clear();
            renderImagesGrid();
            updateStats();
        }

        function showControls() {
            document.getElementById('controlsPanel').classList.remove('hidden');
            document.getElementById('actionButtons').classList.remove('hidden');
            document.getElementById('stats').classList.remove('hidden');
            document.getElementById('quickActions').classList.remove('hidden');
        }

        function updateStats() {
            const totalSize = uploadedImages.reduce((sum, img) => sum + img.size, 0);
            const processedCount = uploadedImages.filter(img => img.processed).length;
            const selectedCount = selectedIndices.size;
            
            document.getElementById('totalImages').textContent = uploadedImages.length;
            document.getElementById('totalSize').textContent = (totalSize / 1024 / 1024).toFixed(2) + ' MB';
            document.getElementById('processedImages').textContent = processedCount;
            document.getElementById('selectedImages').textContent = selectedCount;
        }

        function setCropPreset(width, height) {
            document.getElementById('cropWidth').value = width;
            document.getElementById('cropHeight').value = height;
            updateLivePreview();
        }

        function setRotation(degrees) {
            currentRotation = degrees;
            updateLivePreview();
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            updateLivePreview();
        }

        function loadWatermarkImage() {
            const file = document.getElementById('watermarkImageInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        watermarkImage = img;
                        updateLivePreview();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // Функции для точной обрезки
        function resetCropValues() {
            document.getElementById('cropTop').value = 0;
            document.getElementById('cropBottom').value = 0;
            document.getElementById('cropLeft').value = 0;
            document.getElementById('cropRight').value = 0;
            document.getElementById('enablePreciseCrop').checked = false;
            updateLivePreview();
        }

        function autoCropWhitespace() {
            if (selectedImageIndex === -1) {
                alert('⚠️ Выберите изображение для авто-обрезки!');
                return;
            }
            
            // Упрощенная авто-обрезка - обрезает по 10% с каждой стороны
            const img = uploadedImages[selectedImageIndex].image;
            const cropAmount = Math.min(img.width, img.height) * 0.05; // 5% от меньшей стороны
            
            document.getElementById('cropTop').value = Math.floor(cropAmount);
            document.getElementById('cropBottom').value = Math.floor(cropAmount);
            document.getElementById('cropLeft').value = Math.floor(cropAmount);
            document.getElementById('cropRight').value = Math.floor(cropAmount);
            document.getElementById('enablePreciseCrop').checked = true;
            
            updateLivePreview();
            alert('✨ Применена авто-обрезка пустых областей!');
        }

        function updateCropInfo() {
            if (selectedImageIndex === -1) return;
            
            const img = uploadedImages[selectedImageIndex].image;
            const cropTop = parseInt(document.getElementById('cropTop').value) || 0;
            const cropBottom = parseInt(document.getElementById('cropBottom').value) || 0;
            const cropLeft = parseInt(document.getElementById('cropLeft').value) || 0;
            const cropRight = parseInt(document.getElementById('cropRight').value) || 0;
            
            const newWidth = img.width - cropLeft - cropRight;
            const newHeight = img.height - cropTop - cropBottom;
            
            const cropInfo = document.getElementById('cropInfo');
            const cropWarning = document.getElementById('cropWarning');
            
            if (newWidth <= 0 || newHeight <= 0) {
                cropInfo.innerHTML = '⚠️ Слишком сильная обрезка! Проверьте значения.';
                cropInfo.style.color = '#ff4444';
                cropWarning.classList.remove('hidden');
                
                // Автоматически обновляем поля размеров
                document.getElementById('cropWidth').value = Math.max(1, newWidth);
                document.getElementById('cropHeight').value = Math.max(1, newHeight);
            } else {
                cropInfo.innerHTML = `
                    📏 Исходный: ${img.width} × ${img.height}px<br>
                    ✂️ После обрезки: ${newWidth} × ${newHeight}px<br>
                    🗑️ Удалено: ${cropTop + cropBottom + cropLeft + cropRight}px
                `;
                cropInfo.style.color = '#667eea';
                cropWarning.classList.add('hidden');
                
                // Автоматически обновляем поля размеров на значения после обрезки
                document.getElementById('cropWidth').value = newWidth;
                document.getElementById('cropHeight').value = newHeight;
            }
        }

        function showLivePreview() {
            if (selectedIndices.size === 0 && uploadedImages.length > 0) {
                selectedImageIndex = 0;
            } else if (selectedIndices.size > 0) {
                selectedImageIndex = Array.from(selectedIndices)[0];
            } else {
                alert('⚠️ Загрузите изображения для предпросмотра!');
                return;
            }
            
            previewImage(selectedImageIndex);
        }

        function previewImage(index) {
            selectedImageIndex = index;
            const imageData = uploadedImages[index];
            
            // Показываем оригинал
            const originalImg = document.getElementById('originalImage');
            originalImg.src = imageData.image.src;
            
            // Обновляем информацию об оригинале
            updateImageInfo('originalInfo', imageData.image, imageData.size, imageData.name);
            
            // Показываем секцию предпросмотра
            document.getElementById('previewSection').classList.add('active');
            
            // Обрабатываем изображение
            updateLivePreview();
            
            // Прокручиваем к предпросмотру
            document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function updateLivePreview() {
            if (selectedImageIndex === -1) return;
            
            const imageData = uploadedImages[selectedImageIndex];
            const canvas = processImage(imageData.image);
            
            // Обновляем информацию об обрезке
            updateCropInfo();
            
            // Обновляем информацию об обработанном изображении
            canvas.toBlob(blob => {
                if (blob) {
                    updateImageInfo('processedInfo', canvas, blob.size, 'Обработанное');
                }
            }, document.getElementById('exportFormat').value, document.getElementById('qualityRange').value / 100);
        }

        function updateImageInfo(elementId, imgOrCanvas, size, name) {
            const width = imgOrCanvas.width;
            const height = imgOrCanvas.height;
            const sizeKB = (size / 1024).toFixed(2);
            
            const infoHtml = `
                <div class="info-row">
                    <span class="info-label">Название:</span>
                    <span>${name}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Размер:</span>
                    <span>${width} × ${height} px</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Объем:</span>
                    <span>${sizeKB} KB</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Соотношение:</span>
                    <span>${(width/height).toFixed(2)}:1</span>
                </div>
            `;
            
            document.getElementById(elementId).innerHTML = infoHtml;
        }

        function hidePreview() {
            document.getElementById('previewSection').classList.remove('active');
        }

        function processImage(img) {
            const canvas = document.getElementById('previewCanvas');
            const ctx = canvas.getContext('2d');
            
            // Получаем параметры точной обрезки
            const enablePreciseCrop = document.getElementById('enablePreciseCrop').checked;
            const cropTop = parseInt(document.getElementById('cropTop').value) || 0;
            const cropBottom = parseInt(document.getElementById('cropBottom').value) || 0;
            const cropLeft = parseInt(document.getElementById('cropLeft').value) || 0;
            const cropRight = parseInt(document.getElementById('cropRight').value) || 0;
            
            // Определяем источник изображения после точной обрезки
            let sourceImg = img;
            let sourceWidth = img.width;
            let sourceHeight = img.height;
            let sourceX = 0;
            let sourceY = 0;
            
            if (enablePreciseCrop) {
                sourceX = cropLeft;
                sourceY = cropTop;
                sourceWidth = img.width - cropLeft - cropRight;
                sourceHeight = img.height - cropTop - cropBottom;
                
                // Проверяем корректность обрезки
                if (sourceWidth <= 0 || sourceHeight <= 0) {
                    sourceWidth = img.width;
                    sourceHeight = img.height;
                    sourceX = 0;
                    sourceY = 0;
                }
            }
            
            // Получаем остальные параметры
            const scale = document.getElementById('scaleRange').value / 100;
            let cropWidth = parseInt(document.getElementById('cropWidth').value);
            let cropHeight = parseInt(document.getElementById('cropHeight').value);
            const maintainAspect = document.getElementById('maintainAspect').checked;
            const flipH = document.getElementById('flipHorizontal').checked;
            const flipV = document.getElementById('flipVertical').checked;
            
            // Если включена точная обрезка, используем размеры после обрезки
            if (enablePreciseCrop) {
                cropWidth = sourceWidth;
                cropHeight = sourceHeight;
            }
            
            // Вычисляем целевые размеры
            let targetWidth = cropWidth * scale;
            let targetHeight = cropHeight * scale;
            
            if (maintainAspect) {
                const aspectRatio = sourceWidth / sourceHeight;
                if (targetWidth / targetHeight > aspectRatio) {
                    targetWidth = targetHeight * aspectRatio;
                } else {
                    targetHeight = targetWidth / aspectRatio;
                }
            }
            
            // Учитываем поворот для размеров canvas
            if (currentRotation === 90 || currentRotation === 270) {
                canvas.width = targetHeight;
                canvas.height = targetWidth;
            } else {
                canvas.width = targetWidth;
                canvas.height = targetHeight;
            }
            
            // Очистка
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Сохраняем контекст
            ctx.save();
            
            // Применяем трансформации
            ctx.translate(canvas.width / 2, canvas.height / 2);
            
            // Отражения
            if (flipH) ctx.scale(-1, 1);
            if (flipV) ctx.scale(1, -1);
            
            // Поворот
            ctx.rotate(currentRotation * Math.PI / 180);
            
            // Применяем фильтры CSS
            const brightness = document.getElementById('brightnessRange').value;
            const contrast = document.getElementById('contrastRange').value;
            const saturation = document.getElementById('saturationRange').value;
            const hue = document.getElementById('hueRange').value;
            const blur = document.getElementById('blurRange').value;
            
            let filterString = `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturation}%) hue-rotate(${hue}deg) blur(${blur}px)`;
            
            if (currentFilter === 'grayscale') {
                filterString += ' grayscale(100%)';
            } else if (currentFilter === 'sepia') {
                filterString += ' sepia(100%)';
            } else if (currentFilter === 'invert') {
                filterString += ' invert(100%)';
            } else if (currentFilter === 'vintage') {
                filterString += ' sepia(50%) contrast(120%) brightness(90%)';
            } else if (currentFilter === 'cold') {
                filterString += ' hue-rotate(180deg) saturate(120%)';
            } else if (currentFilter === 'warm') {
                filterString += ' sepia(30%) saturate(120%)';
            }
            
            ctx.filter = filterString;
            
            // Рисуем изображение с учетом точной обрезки
            if (currentRotation === 90 || currentRotation === 270) {
                ctx.drawImage(img, sourceX, sourceY, sourceWidth, sourceHeight, 
                             -targetHeight / 2, -targetWidth / 2, targetHeight, targetWidth);
            } else {
                ctx.drawImage(img, sourceX, sourceY, sourceWidth, sourceHeight,
                             -targetWidth / 2, -targetHeight / 2, targetWidth, targetHeight);
            }
            
            ctx.restore();
            
            // Применяем дополнительные эффекты
            applyAdvancedEffects(ctx, canvas);
            
            // Рамка
            applyBorder(ctx, canvas);
            
            // Водяной знак
            addWatermark(ctx, canvas);
            
            return canvas;
        }

        function applyAdvancedEffects(ctx, canvas) {
            // Виньетка
            const vignette = document.getElementById('vignetteRange').value / 100;
            if (vignette > 0) {
                const gradient = ctx.createRadialGradient(
                    canvas.width / 2, canvas.height / 2, 0,
                    canvas.width / 2, canvas.height / 2, Math.max(canvas.width, canvas.height) / 2
                );
                gradient.addColorStop(0, `rgba(0,0,0,0)`);
                gradient.addColorStop(1, `rgba(0,0,0,${vignette})`);
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // Резкость (упрощенная версия)
            const sharpness = document.getElementById('sharpnessRange').value;
            if (sharpness > 0) {
                // Резкость через обработку изображения требует imageData
                // Здесь используем визуальное приближение через контраст
            }
        }

        function applyBorder(ctx, canvas) {
            const borderWidth = document.getElementById('borderWidthRange').value;
            const borderColor = document.getElementById('borderColor').value;
            const borderRadius = document.getElementById('borderRadiusRange').value;
            const shadow = document.getElementById('shadowRange').value;
            
            if (borderWidth > 0) {
                ctx.strokeStyle = borderColor;
                ctx.lineWidth = borderWidth;
                
                if (borderRadius > 0) {
                    roundRect(ctx, borderWidth/2, borderWidth/2, 
                             canvas.width - borderWidth, canvas.height - borderWidth, 
                             borderRadius);
                    ctx.stroke();
                } else {
                    ctx.strokeRect(borderWidth/2, borderWidth/2, 
                                  canvas.width - borderWidth, canvas.height - borderWidth);
                }
            }
            
            if (shadow > 0) {
                ctx.shadowColor = 'rgba(0,0,0,0.5)';
                ctx.shadowBlur = shadow;
                ctx.shadowOffsetX = shadow / 2;
                ctx.shadowOffsetY = shadow / 2;
            }
        }

        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }

        function addWatermark(ctx, canvas) {
            const watermarkText = document.getElementById('watermarkText').value;
            const fontSize = document.getElementById('fontSizeRange').value;
            const color = document.getElementById('watermarkColor').value;
            const opacity = document.getElementById('opacityRange').value / 100;
            const position = document.getElementById('watermarkPosition').value;
            const withShadow = document.getElementById('watermarkShadow').checked;
            const withBackground = document.getElementById('watermarkBackground').checked;
            const bgColor = document.getElementById('watermarkBgColor').value;
            const bgOpacity = document.getElementById('bgOpacityRange').value / 100;
            const bgPadding = parseInt(document.getElementById('bgPaddingRange').value) || 10;
            
            ctx.save();
            
            // Текстовый водяной знак
            if (watermarkText) {
                ctx.font = `bold ${fontSize}px Arial`;
                const textWidth = ctx.measureText(watermarkText).width;
                const textHeight = parseInt(fontSize);
                
                if (position === 'tiled') {
                    // Повторяющийся водяной знак
                    const spacing = 200;
                    for (let y = 0; y < canvas.height; y += spacing) {
                        for (let x = 0; x < canvas.width; x += spacing) {
                            drawWatermarkText(ctx, watermarkText, x, y + textHeight, 
                                            textWidth, textHeight, color, opacity, 
                                            withShadow, withBackground, bgColor, bgOpacity, bgPadding);
                        }
                    }
                } else {
                    const {x, y} = getWatermarkPosition(position, canvas, textWidth, textHeight);
                    drawWatermarkText(ctx, watermarkText, x, y, 
                                    textWidth, textHeight, color, opacity, 
                                    withShadow, withBackground, bgColor, bgOpacity, bgPadding);
                }
            }
            
            // Водяной знак из изображения
            if (watermarkImage) {
                ctx.globalAlpha = opacity;
                const wmWidth = watermarkImage.width * (fontSize / 50);
                const wmHeight = watermarkImage.height * (fontSize / 50);
                
                if (position === 'tiled') {
                    const spacing = Math.max(wmWidth, wmHeight) + 50;
                    for (let y = 0; y < canvas.height; y += spacing) {
                        for (let x = 0; x < canvas.width; x += spacing) {
                            ctx.drawImage(watermarkImage, x, y, wmWidth, wmHeight);
                        }
                    }
                } else {
                    const {x, y} = getWatermarkPosition(position, canvas, wmWidth, wmHeight);
                    ctx.drawImage(watermarkImage, x, y, wmWidth, wmHeight);
                }
            }
            
            ctx.restore();
        }

        function drawWatermarkText(ctx, text, x, y, width, height, color, opacity, 
                                   withShadow, withBackground, bgColor, bgOpacity, bgPadding) {
            ctx.save();
            
            // Рисуем подложку
            if (withBackground) {
                ctx.globalAlpha = bgOpacity;
                ctx.fillStyle = bgColor;
                ctx.fillRect(x - bgPadding, y - height - bgPadding, 
                           width + bgPadding * 2, height + bgPadding * 2);
            }
            
            // Рисуем текст
            ctx.globalAlpha = opacity;
            ctx.fillStyle = color;
            
            if (withShadow) {
                ctx.shadowColor = 'rgba(0,0,0,0.7)';
                ctx.shadowBlur = 5;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
            }
            
            ctx.fillText(text, x, y);
            
            ctx.restore();
        }

        function getWatermarkPosition(position, canvas, width, height) {
            const padding = 20;
            let x, y;
            
            switch(position) {
                case 'top-left':
                    x = padding;
                    y = height + padding;
                    break;
                case 'top-center':
                    x = (canvas.width - width) / 2;
                    y = height + padding;
                    break;
                case 'top-right':
                    x = canvas.width - width - padding;
                    y = height + padding;
                    break;
                case 'center-left':
                    x = padding;
                    y = canvas.height / 2;
                    break;
                case 'center-right':
                    x = canvas.width - width - padding;
                    y = canvas.height / 2;
                    break;
                case 'bottom-left':
                    x = padding;
                    y = canvas.height - padding;
                    break;
                case 'bottom-center':
                    x = (canvas.width - width) / 2;
                    y = canvas.height - padding;
                    break;
                case 'bottom-right':
                    x = canvas.width - width - padding;
                    y = canvas.height - padding;
                    break;
                default: // center
                    x = (canvas.width - width) / 2;
                    y = canvas.height / 2;
            }
            
            return {x, y};
        }

        async function processSelectedImages() {
            if (selectedIndices.size === 0) {
                alert('⚠️ Выберите изображения для обработки!');
                return;
            }
            
            await processImages(Array.from(selectedIndices));
        }

        async function processAllImages() {
            const indices = uploadedImages.map((_, index) => index);
            await processImages(indices);
        }

        async function processImages(indices) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            progressBar.style.display = 'block';
            
            for (let i = 0; i < indices.length; i++) {
                const index = indices[i];
                const imageData = uploadedImages[index];
                
                // Создаем временный canvas для обработки
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                // Обрабатываем изображение
                const processedCanvas = processImageToCanvas(imageData.image, tempCanvas, tempCtx);
                
                const format = document.getElementById('exportFormat').value;
                const quality = document.getElementById('qualityRange').value / 100;
                
                const blob = await new Promise(resolve => {
                    processedCanvas.toBlob(resolve, format, quality);
                });
                
                const prefix = document.getElementById('filePrefix').value || '';
                const suffix = document.getElementById('fileSuffix').value || '';
                const extension = format.split('/')[1];
                const baseName = imageData.name.replace(/\.[^/.]+$/, '');
                const newName = prefix + baseName + suffix + '.' + extension;
                
                processedImages.push({
                    blob: blob,
                    name: newName,
                    originalIndex: index
                });
                
                imageData.processed = true;
                
                const progress = ((i + 1) / indices.length * 100).toFixed(0);
                progressFill.style.width = progress + '%';
                progressFill.textContent = progress + '%';
            }
            
            renderImagesGrid();
            updateStats();
            
            setTimeout(() => {
                progressBar.style.display = 'none';
                alert(`✅ Обработано ${indices.length} изображений! Теперь можете скачать их.`);
            }, 500);
        }

        function processImageToCanvas(img, canvas, ctx) {
            // Получаем параметры точной обрезки
            const enablePreciseCrop = document.getElementById('enablePreciseCrop').checked;
            const cropTop = parseInt(document.getElementById('cropTop').value) || 0;
            const cropBottom = parseInt(document.getElementById('cropBottom').value) || 0;
            const cropLeft = parseInt(document.getElementById('cropLeft').value) || 0;
            const cropRight = parseInt(document.getElementById('cropRight').value) || 0;
            
            // Определяем источник изображения после точной обрезки
            let sourceImg = img;
            let sourceWidth = img.width;
            let sourceHeight = img.height;
            let sourceX = 0;
            let sourceY = 0;
            
            if (enablePreciseCrop) {
                sourceX = cropLeft;
                sourceY = cropTop;
                sourceWidth = img.width - cropLeft - cropRight;
                sourceHeight = img.height - cropTop - cropBottom;
                
                // Проверяем корректность обрезки
                if (sourceWidth <= 0 || sourceHeight <= 0) {
                    sourceWidth = img.width;
                    sourceHeight = img.height;
                    sourceX = 0;
                    sourceY = 0;
                }
            }
            
            const scale = document.getElementById('scaleRange').value / 100;
            let cropWidth = parseInt(document.getElementById('cropWidth').value);
            let cropHeight = parseInt(document.getElementById('cropHeight').value);
            const maintainAspect = document.getElementById('maintainAspect').checked;
            const flipH = document.getElementById('flipHorizontal').checked;
            const flipV = document.getElementById('flipVertical').checked;
            
            // Если включена точная обрезка, используем размеры после обрезки
            if (enablePreciseCrop) {
                cropWidth = sourceWidth;
                cropHeight = sourceHeight;
            }
            
            let targetWidth = cropWidth * scale;
            let targetHeight = cropHeight * scale;
            
            if (maintainAspect) {
                const aspectRatio = sourceWidth / sourceHeight;
                if (targetWidth / targetHeight > aspectRatio) {
                    targetWidth = targetHeight * aspectRatio;
                } else {
                    targetHeight = targetWidth / aspectRatio;
                }
            }
            
            if (currentRotation === 90 || currentRotation === 270) {
                canvas.width = targetHeight;
                canvas.height = targetWidth;
            } else {
                canvas.width = targetWidth;
                canvas.height = targetHeight;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height / 2);
            
            if (flipH) ctx.scale(-1, 1);
            if (flipV) ctx.scale(1, -1);
            ctx.rotate(currentRotation * Math.PI / 180);
            
            const brightness = document.getElementById('brightnessRange').value;
            const contrast = document.getElementById('contrastRange').value;
            const saturation = document.getElementById('saturationRange').value;
            const hue = document.getElementById('hueRange').value;
            const blur = document.getElementById('blurRange').value;
            
            let filterString = `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturation}%) hue-rotate(${hue}deg) blur(${blur}px)`;
            
            if (currentFilter === 'grayscale') {
                filterString += ' grayscale(100%)';
            } else if (currentFilter === 'sepia') {
                filterString += ' sepia(100%)';
            } else if (currentFilter === 'invert') {
                filterString += ' invert(100%)';
            } else if (currentFilter === 'vintage') {
                filterString += ' sepia(50%) contrast(120%) brightness(90%)';
            } else if (currentFilter === 'cold') {
                filterString += ' hue-rotate(180deg) saturate(120%)';
            } else if (currentFilter === 'warm') {
                filterString += ' sepia(30%) saturate(120%)';
            }
            
            ctx.filter = filterString;
            
            // Рисуем изображение с учетом точной обрезки
            if (currentRotation === 90 || currentRotation === 270) {
                ctx.drawImage(img, sourceX, sourceY, sourceWidth, sourceHeight,
                             -targetHeight / 2, -targetWidth / 2, targetHeight, targetWidth);
            } else {
                ctx.drawImage(img, sourceX, sourceY, sourceWidth, sourceHeight,
                             -targetWidth / 2, -targetHeight / 2, targetWidth, targetHeight);
            }
            
            ctx.restore();
            
            applyAdvancedEffects(ctx, canvas);
            applyBorder(ctx, canvas);
            addWatermark(ctx, canvas);
            
            return canvas;
        }

        async function downloadSelected() {
            const selected = processedImages.filter(img => 
                selectedIndices.has(img.originalIndex)
            );
            
            if (selected.length === 0) {
                alert('⚠️ Сначала обработайте выбранные изображения!');
                return;
            }
            
            if (selected.length === 1) {
                downloadSingle(selected[0]);
            } else {
                await downloadMultipleAsZip(selected, 'selected_images.zip');
            }
        }

        function downloadSingle(imgData) {
            const url = URL.createObjectURL(imgData.blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = imgData.name;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function downloadAll() {
            if (processedImages.length === 0) {
                alert('⚠️ Сначала обработайте изображения!');
                return;
            }
            
            await downloadMultipleAsZip(processedImages, 'edited_images.zip');
        }

        async function downloadMultipleAsZip(images, zipName) {
            const zip = new JSZip();
            
            images.forEach((img, index) => {
                zip.file(img.name, img.blob);
            });
            
            const content = await zip.generateAsync({ 
                type: 'blob',
                compression: "DEFLATE",
                compressionOptions: { level: 6 }
            });
            
            const url = URL.createObjectURL(content);
            const a = document.createElement('a');
            a.href = url;
            a.download = zipName;
            a.click();
            URL.revokeObjectURL(url);
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            selectedIndices.delete(index);
            
            // Обновляем индексы в selectedIndices
            const newIndices = new Set();
            selectedIndices.forEach(i => {
                if (i > index) {
                    newIndices.add(i - 1);
                } else if (i < index) {
                    newIndices.add(i);
                }
            });
            selectedIndices = newIndices;
            
            renderImagesGrid();
            updateStats();
            
            if (uploadedImages.length === 0) {
                clearAll();
            }
        }

        function renderImagesGrid() {
            const grid = document.getElementById('imagesGrid');
            grid.innerHTML = '';
            uploadedImages.forEach((_, index) => {
                renderImageCard(index);
            });
        }

        function applyToSelected() {
            if (selectedIndices.size === 0) {
                alert('⚠️ Выберите изображения для применения настроек!');
                return;
            }
            alert('✅ Настройки будут применены при обработке выбранных изображений!');
        }

        function resetAllSettings() {
            document.getElementById('scaleRange').value = 100;
            document.getElementById('qualityRange').value = 92;
            document.getElementById('cropWidth').value = 1920;
            document.getElementById('cropHeight').value = 1080;
            document.getElementById('maintainAspect').checked = false;
            document.getElementById('flipHorizontal').checked = false;
            document.getElementById('flipVertical').checked = false;
            document.getElementById('watermarkText').value = '';
            document.getElementById('fontSizeRange').value = 40;
            document.getElementById('opacityRange').value = 60;
            document.getElementById('watermarkBackground').checked = true;
            document.getElementById('bgOpacityRange').value = 50;
            document.getElementById('bgPaddingRange').value = 10;
            document.getElementById('brightnessRange').value = 100;
            document.getElementById('contrastRange').value = 100;
            document.getElementById('saturationRange').value = 100;
            document.getElementById('hueRange').value = 0;
            document.getElementById('blurRange').value = 0;
            document.getElementById('sharpnessRange').value = 0;
            document.getElementById('vignetteRange').value = 0;
            document.getElementById('borderWidthRange').value = 0;
            document.getElementById('borderRadiusRange').value = 0;
            document.getElementById('shadowRange').value = 0;
            
            // Сброс настроек точной обрезки
            resetCropValues();
            
            currentRotation = 0;
            currentFilter = 'none';
            watermarkImage = null;
            
            updateRangeValues();
            updateLivePreview();
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.filter-btn').classList.add('active');
        }

        function autoEnhance() {
            document.getElementById('brightnessRange').value = 110;
            document.getElementById('contrastRange').value = 120;
            document.getElementById('saturationRange').value = 110;
            document.getElementById('sharpnessRange').value = 3;
            
            updateRangeValues();
            updateLivePreview();
            
            alert('✨ Применены настройки авто-улучшения!');
        }

        function clearAll() {
            uploadedImages = [];
            processedImages = [];
            selectedIndices.clear();
            watermarkImage = null;
            document.getElementById('imagesGrid').innerHTML = '';
            document.getElementById('controlsPanel').classList.add('hidden');
            document.getElementById('actionButtons').classList.add('hidden');
            document.getElementById('stats').classList.add('hidden');
            document.getElementById('quickActions').classList.add('hidden');
            document.getElementById('previewSection').classList.remove('active');
            updateStats();
            resetAllSettings();
        }
    </script>
</body>
</html>